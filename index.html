<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Player</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #333;
            --danger-color: #d9534f;
            --success-color: #5cb85c;
            --border-radius: 8px;
            --folder-color: #ffc107;
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }

        /* General Helper */
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        
        /* Header & Logo */
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .app-logo { width: 40px; height: 40px; stroke: var(--primary-color); }
        header h1 { color: var(--primary-color); margin: 0; font-size: 2rem; }

        .card { background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 25px; margin-bottom: 25px; }
        .btn { display: inline-block; padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; text-align: center; transition: background-color 0.2s, transform 0.1s; margin: 5px; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #357abd; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #e09416; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #4a9d4a; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #c9302c; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* DASHBOARD STYLES */
        #quiz-dashboard { max-width: 1200px; margin: auto; padding: 20px;}
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;}
        #dashboard-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .breadcrumb-trail { font-size: 1.1em; color: #555; margin-bottom: 20px; }
        .breadcrumb-trail a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .breadcrumb-trail a:hover { text-decoration: underline; }
        .breadcrumb-trail span { margin: 0 8px; }
        
        /* Card & Folder Item Styles */
        .dashboard-item { background: var(--surface-color); border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .dashboard-item:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .card-content { padding: 20px; cursor: pointer; }
        .card-icon { font-size: 3em; margin-bottom: 10px; line-height: 1; }
        .folder-item .card-icon { color: var(--folder-color); }
        .quiz-item .card-icon { color: var(--primary-color); }
        .item-name { font-size: 1.1em; font-weight: 600; margin: 0; color: #333; word-break: break-word; }
        .item-type-label { font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .item-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
        .options-btn { background: none; border: none; font-size: 24px; color: #888; cursor: pointer; padding: 5px; border-radius: 50%; line-height: 1;}
        .options-btn:hover { background: #f0f0f0; color: #333; }
        .share-btn { background: none; border: none; font-size: 20px; color: #888; cursor: pointer; padding: 5px; border-radius: 50%; line-height: 1;}
        .share-btn:hover { background: #f0f0f0; color: var(--primary-color); }
        .dropdown-menu { position: absolute; top: 40px; right: 10px; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 180px; overflow: hidden; padding: 5px 0; }
        .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; font-size: 14px; cursor: pointer; }
        .dropdown-menu button:hover { background: #f5f5f5; }
        .dropdown-menu button.danger { color: var(--danger-color); }

        /* --- STUDENT VIEW / SHARED LINK MODES --- */
        body.student-view header { display: none; } 
        body.student-view .dashboard-header div { display: none; } 
        body.student-view .dashboard-header h1 { width: 100%; text-align: center; } 
        body.student-view .item-actions { display: none; } 
        body.student-view #quiz-builder { display: none !important; } 
        body.student-view .breadcrumb-trail a[data-folder-id="root"] { display: none; } 
        body.student-view .breadcrumb-trail span:first-child { display: none; }
        
        /* BUILDER CONTAINER */
        #quiz-builder { max-width: 800px; }
        #quiz-builder-header { display: flex; justify-content: space-between; align-items: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="file"], .form-group input[type="date"], .form-group input[type="time"], .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; transition: border-color 0.2s; font-family: inherit; font-size: 1rem;}
        .form-group textarea { resize: vertical; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); }
        .actions { text-align: center; margin-top: 20px; }
        .question-card { position: relative; }
        .delete-question-btn { position: absolute; top: 10px; right: 10px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .toggle-switch-container { display: flex; gap: 15px; flex-wrap: wrap; }
        .toggle-switch { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .text-input-container { display: block; }
        .image-uploader { display: none; }
        .question-image-preview, #quiz-logo-preview { max-width: 100%; max-height: 150px; margin-top: 10px; display: none; border-radius: 8px; }
        .options-container { margin-top: 10px; }
        .option-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .option-item input[type="radio"] { width: auto; align-self: flex-start; margin-top: 12px;}
        .option-item .rte-container { flex: 1; }
        .delete-option-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .sub-question-card { background-color: #f0f4f8; margin-top: 15px; padding: 15px; position: relative; }
        .delete-sub-question-btn { position: absolute; top: 10px; right: 10px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 16px; cursor: pointer; }
        #backend-connection-status { margin-top: 10px; font-weight: bold; }
        .status-success { color: var(--success-color); }
        .status-error { color: var(--danger-color); }
        .status-processing { color: var(--secondary-color); }

        /* RTE STYLES */
        .rte-container { border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .rte-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 5px; background-color: #f1f1f1; border-bottom: 1px solid #ccc; }
        .rte-toolbar button, .rte-toolbar select { font-family: inherit; border: 1px solid transparent; background-color: transparent; border-radius: 3px; padding: 5px; cursor: pointer; min-width: 30px; }
        .rte-toolbar button:hover, .rte-toolbar select:hover { background-color: #e1e1e1; border-color: #ccc; }
        .rte-toolbar select { padding: 4px 2px; }
        .rte-toolbar input[type="color"] { width: 30px; height: 26px; padding: 2px; border: 1px solid #ccc; background: white; cursor: pointer; }
        .rte-toolbar .rte-separator { width: 1px; height: 20px; background-color: #ccc; margin: 0 5px; }
        .rte-content { min-height: 80px; padding: 10px; outline: none; background-color: white; font-size: 1rem; }
        .option-item .rte-content { min-height: 40px; }
        #special-char-popup { position: fixed; z-index: 10005; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 6px; padding: 10px; display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; }
        
        /* ADVERTISEMENT STYLES - BUILDER */
        #ad-links-container { margin-top: 15px; padding: 10px; background: #f1f1f1; border-radius: 4px; display: none; }
        .ad-link-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #ddd; word-break: break-all; font-size: 14px; }
        .ad-link-text { flex: 1; margin-right: 10px; color: #0066cc; }
        .remove-ad-btn { background: #ffdddd; color: #d00; border: none; border-radius: 3px; padding: 2px 8px; cursor: pointer; font-size: 12px; }

        /* ADVERTISEMENT STYLES - PLAYER SIDEBAR */
        #ad-side-panel {
            margin-bottom: 20px;
            padding: 0;
            background: #000;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: block;
            position: relative; 
            z-index: 1000;
        }
        
        .ad-label {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            z-index: 10;
            text-transform: uppercase;
            font-weight: bold;
            pointer-events: none;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        #ad-side-panel.empty { display: none; }

        /* PRE-QUIZ STYLES */
        #pre-quiz-questions-section { border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px; }
        #pre-quiz-questions-list { list-style-type: none; padding: 0; margin-top: 15px; }
        .pre-quiz-list-item { background: #f8f9fa; border-radius: 4px; padding: 10px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 15px;}
        
        /* FULL-SCREEN QUIZ PLAY MODE */
        #quiz-play-fullscreen { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; overflow-y: auto; padding: 0; }
        .quiz-fullscreen-header { background: rgba(255, 255, 255, 0.98); padding: 10px 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 100; border-bottom: 2px solid var(--primary-color); }
        .quiz-header-inner { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .quiz-header-top { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .quiz-title-section { display: flex; align-items: center; gap: 15px; }
        #player-quiz-logo { height: 40px; width: auto; max-width: 150px; object-fit: contain; }
        .quiz-title-section h2 { color: var(--primary-color); margin: 0; font-size: clamp(1em, 2vw, 1.3em); font-weight: 600; }
        .exit-quiz-btn { background: var(--danger-color); color: white; border: none; padding: 6px 14px; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .exit-quiz-btn:hover { background: #c9302c; transform: scale(1.05); }
        .quiz-play-content { max-width: 1200px; margin: 0 auto; padding: 20px 15px; }
        .quiz-play-container { display: flex; gap: 20px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12); }
        .play-left { flex: 1; min-width: 0; }
        .play-right { width: 240px; flex: 0 0 240px; border-left: 2px solid #e3e3e3; padding-left: 16px; }
        .play-question-text { font-size: clamp(17px, 2vw, 20px); font-weight: 400; margin-bottom: 20px; color: #2c3e50; line-height: 1.5; }
        
        /* PLAY BUTTONS ALIGNMENT */
        .play-actions { 
            display: flex; 
            gap: 8px; 
            margin-top: 20px; 
            flex-wrap: nowrap; 
            justify-content: space-between;
        }
        .play-actions .btn { 
            flex: 1; 
            padding: 10px 5px; 
            font-size: 14px; 
            min-width: 0; 
            white-space: nowrap;
        }
        .play-nav-buttons { 
            display: flex; 
            gap: 8px; 
            flex: 2; 
        }
        
        /* THE LOCK SCREEN OVERLAY (Prevents clicks) */
        .quiz-locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            z-index: 50;
            cursor: not-allowed;
        }

        /* TOAST NOTIFICATION */
        #ad-toast {
            visibility: hidden;
            min-width: 280px;
            margin-left: -140px;
            background-color: var(--primary-color);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 99999;
            left: 50%;
            top: 80px;
            font-size: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        #ad-toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 4.5s;
            animation: fadein 0.5s, fadeout 0.5s 4.5s;
        }
        
        @keyframes fadein { from {top: 0; opacity: 0;} to {top: 80px; opacity: 1;} }
        @keyframes fadeout { from {top: 80px; opacity: 1;} to {top: 0; opacity: 0;} }

        /* RESPONSIVE UI FOR MOBILE */
        @media (max-width: 900px) {
            .quiz-play-content { padding: 10px; }
            .quiz-play-container { flex-direction: column; gap: 30px; }
            .play-left { width: 100%; border-right: none; border-bottom: 2px solid #eee; padding-bottom: 20px; }
            
            /* UPDATED: Mobile Sidebar Layout */
            .play-right { 
                width: 100%; 
                flex: none; 
                border-left: none; 
                padding-left: 0; 
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            #ad-side-panel { width: calc(50% - 5px); margin-bottom: 0; flex-grow: 1; }
            .legend { width: calc(50% - 5px); margin-top: 0; flex-grow: 1; }
            .question-panel-wrapper { width: 100%; }
            .question-panel { justify-content: center; }
        }

        /* POPUP/MODAL STYLES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; display: flex; align-items: center; justify-content: center; }
        .modal-card { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 500px; width: 90%; }
        .modal-card h2 { text-align: center; color: var(--primary-color); margin-top: 0; margin-bottom: 20px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        #popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .popup-card { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 800px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; }
        #terms-content-viewer { flex: 1; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 20px; padding: 10px; background: #f8f9fa; }
        #move-folder-list { list-style-type: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; }
        #move-folder-list li { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
        #move-folder-list li:hover { background-color: #f0f7ff; }
        #move-folder-list li.selected { background-color: var(--primary-color); color: white; font-weight: bold; }
        
        /* RESULTS STYLES */
        .results-container { background: white; border-radius: 10px; padding: 30px; max-width: 900px; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .results-header { text-align: center; border-bottom: 3px solid var(--primary-color); padding-bottom: 20px; margin-bottom: 30px; }
        .results-header h1 { color: var(--primary-color); margin: 0 0 10px 0; font-size: 2.5em; }
        .quiz-info, .student-info-results { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .quiz-info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .quiz-info-label { font-weight: 600; color: #666; }
        .score-summary { text-align: center; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; margin-bottom: 30px; }
        .score-summary .big-score { font-size: 4em; font-weight: bold; margin: 15px 0; }
        .score-summary .percentage { font-size: 2em; margin: 10px 0; }
        .detailed-results, .student-info-results { margin-top: 30px; }
        .detailed-results h2, .student-info-results h2 { color: var(--primary-color); border-bottom: 2px solid #e3e3e3; padding-bottom: 10px; margin-bottom: 20px; }
        .result-question { background: #f8f9fa; border-left: 5px solid var(--primary-color); padding: 20px; margin-bottom: 20px; border-radius: 8px; page-break-inside: avoid; }
        .result-question-header { font-weight: 700; font-size: 18px; color: var(--primary-color); margin-bottom: 12px; }
        .result-question-text { font-size: 16px; font-weight: 400; margin-bottom: 15px; color: #2c3e50; }
        .result-question-image { max-width: 100%; max-height: 300px; margin: 15px 0; border-radius: 8px; }
        .result-passage { background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196f3; }
        .result-options { margin: 15px 0; }
        .result-option { padding: 12px 15px; margin-bottom: 8px; border-radius: 6px; border: 2px solid #ddd; display: flex; align-items: flex-start; gap: 10px; }
        .result-option.correct { background: #d4edda; border-color: #28a745; font-weight: 600; }
        .result-option.wrong { background: #f8d7da; border-color: #dc3545; }
        .result-status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px; margin-top: 10px; }
        .result-status.correct-answer { background: #d4edda; color: #155724; }
        .result-status.wrong-answer { background: #f8d7da; color: #721c24; }
        .result-status.not-answered { background: #fff3cd; color: #856404; }
        .print-actions { text-align: center; margin: 30px 0; }

        /* LOADING SPINNER */
        #student-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #student-loading.hidden { display: none; }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid var(--primary-color); width: 50px; height: 50px; -webkit-animation: spin 1s linear infinite; /* Safari */ animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MINIFIED HELPER STYLES */
        .spreadsheet-container { overflow-x: auto; margin-bottom: 15px; border: 1px solid #ccc; max-height: 400px; } .spreadsheet-table { border-collapse: collapse; width: 100%; min-width: 800px; font-size: 13px; } .spreadsheet-table th, .spreadsheet-table td { border: 1px solid #ddd; padding: 0; min-width: 100px; position: relative; } .spreadsheet-table th { background: #f1f1f1; padding: 10px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #ccc; } .spreadsheet-cell { width: 100%; height: 100%; min-height: 30px; padding: 8px; outline: none; white-space: pre-wrap; overflow: hidden; display: block; } .spreadsheet-row-selected { background-color: #fff3cd !important; }
        .explanation-section { margin-top: 20px; background: #e8f5e9; padding: 15px; border-radius: 8px; border: 1px solid #c8e6c9; } .result-explanation { background: #e3f2fd; border: 1px solid #bbdefb; padding: 15px; margin-top: 15px; border-radius: 6px; color: #0d47a1; }
        .quiz-title-section p { margin: 2px 0 0 0; color: #666; font-size: clamp(0.75em, 1.2vw, 0.85em); } #quiz-timer { font-size: clamp(0.85em, 1.5vw, 1em); font-weight: 600; color: var(--primary-color); text-align: right; margin-top: 5px; } .question-panel-header { font-weight: 700; font-size: 16px; margin-bottom: 12px; color: var(--primary-color); } .question-panel { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; } .q-chip { width: 38px; height: 38px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #ccc; user-select: none; font-weight: 600; font-size: 14px; transition: all 0.2s; } .q-chip:hover { transform: scale(1.08); box-shadow: 0 2px 8px rgba(0,0,0,0.15); } .q-chip.green { background: #d4edda; color: #155724; border-color: #8fd28f; } .q-chip.red { background: #f8d7da; color: #721c24; border-color: #f5c6cb; } .q-chip.yellow { background: #fff3cd; color: #856404; border-color: #ffeaa7; } .q-chip.active { outline: 3px solid var(--primary-color); outline-offset: 2px; } .legend { margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; } .legend-title { font-weight: 600; margin-bottom: 8px; font-size: 13px; } .legend-item { display: block; margin-bottom: 6px; font-size: 12px; } .legend-item:before { content: "‚óè"; margin-right: 6px; font-size: 16px; } .legend-item.green:before { color: #28a745; } .legend-item.red:before { color: #dc3545; } .legend-item.yellow:before { color: #ffc107; } .play-question-view { background: white; padding: 0; position: relative; } .play-question-number { font-size: clamp(16px, 1.8vw, 18px); font-weight: 700; color: var(--primary-color); margin-bottom: 15px; } .play-question-image { max-width: 100%; max-height: 400px; margin: 15px auto; border-radius: 8px; display: block; object-fit: contain; } .play-passage-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-color); } .play-passage-label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; } .play-options-container { margin: 15px 0; } .play-option { padding: clamp(10px, 1.8vw, 14px); border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; background: white; font-size: clamp(14px, 1.6vw, 15px); display: flex; align-items: flex-start; gap: 10px; } .play-option:hover:not(.disabled) { border-color: var(--primary-color); background: #f0f7ff; transform: translateX(5px); } .play-option.selected { border-color: var(--primary-color); background: #e3f2fd; font-weight: 600; } .play-option.disabled { opacity: 0.7; cursor: not-allowed; } .option-label { font-weight: 700; color: var(--primary-color); min-width: 20px; padding-top: 2px;} .option-text { flex: 1; } .submit-inside-card { margin-top: 25px; padding-top: 20px; border-top: 2px solid #e3e3e3; text-align: center; } .submit-inside-card .btn { font-size: 16px; padding: 12px 40px; }
        .popup-card h2 { text-align: center; color: var(--primary-color); margin-top: 0; margin-bottom: 20px; } #terms-content-viewer iframe, #terms-content-viewer img { width: 100%; height: 100%; min-height: 300px; border: none; } #terms-agreement-section { margin-bottom: 20px; } .terms-checkbox { display: block; margin-bottom: 10px; font-size: 15px; cursor: pointer; } .terms-checkbox input { margin-right: 10px; transform: scale(1.2); vertical-align: middle; } .terms-checkbox.mandatory { margin-top: 15px; font-size: 16px; } #student-info-form-container { max-height: 50vh; overflow-y: auto; padding-right: 10px; } #quiz-start-countdown { text-align:center; font-size: 1.2em; font-weight: 600; color: var(--primary-color); margin: 20px 0; }
        
        /* AD START OVERLAY (Initial) */
        #ad-start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface-color); z-index: 10002; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px; }
        #ad-start-overlay h1 { color: var(--primary-color); margin-bottom: 10px; }
        #ad-start-overlay p { font-size: 1.2em; color: #666; margin-bottom: 30px; }

        @media print {
            body { background: white; }
            .quiz-play-content { padding: 0; }
            .quiz-fullscreen-header, .print-actions, .exit-quiz-btn, #popup-overlay, #ad-start-overlay, #ad-toast { display: none; }
            .results-container { box-shadow: none; max-width: 100%; page-break-after: always; }
            .result-question { page-break-inside: avoid; }
            #quiz-play-fullscreen { position: static; width: 100%; height: auto; background: white; }
        }
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div id="student-loading" class="hidden">
        <div class="loader"></div>
        <h2 id="loading-text">Loading Quiz...</h2>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="ad-toast">You're writing a free test. Click the YouTube Play button to continue!</div>

    <!-- HEADER WITH LOGO -->
    <header>
        <div class="logo-container">
            <svg class="app-logo" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <h1>Quiz Test Maker</h1>
        </div>
    </header>

    <!-- MODALS & POPUPS (reused for dashboard actions) -->
    <div id="action-modal-overlay" class="modal-overlay hidden">
        <div id="create-folder-modal" class="modal-card hidden">
            <h2>Create New Folder</h2>
            <div class="form-group"><label for="new-folder-name">Folder Name</label><input type="text" id="new-folder-name" placeholder="e.g., History Quizzes"></div>
            <div class="modal-actions"><button id="create-folder-cancel" class="btn btn-secondary">Cancel</button><button id="create-folder-confirm" class="btn btn-success">Create</button></div>
        </div>
        <div id="move-item-modal" class="modal-card hidden">
            <h2>Move Item To...</h2>
            <ul id="move-folder-list"></ul>
            <div class="modal-actions"><button id="move-item-cancel" class="btn btn-secondary">Cancel</button><button id="move-item-confirm" class="btn btn-success" disabled>Move</button></div>
        </div>
    </div>
    
    <!-- ADVERTISEMENT MODAL -->
    <div id="ad-management-modal-overlay" class="modal-overlay hidden">
        <div class="modal-card">
            <h2>üì¢ Add Advertisement</h2>
            <div class="form-group">
                <label for="ad-link-input">Advertisement Link (Image URL or YouTube Link)</label>
                <input type="text" id="ad-link-input" placeholder="https://youtube.com/watch?v=... or https://example.com/banner.jpg">
            </div>
            <div class="modal-actions">
                <button id="add-ad-link-btn" class="btn btn-primary">Add Link</button>
                <button id="close-ad-modal-btn" class="btn btn-success">Done</button>
            </div>
        </div>
    </div>

    <div id="add-pre-question-modal-overlay" class="modal-overlay hidden"><div class="modal-card"><h2>Add Pre-Quiz Question</h2><div class="form-group"><label for="pre-question-label">Question Label</label><input type="text" id="pre-question-label" placeholder="e.g., Candidate Name"></div><div class="form-group"><label for="pre-question-type">Answer Type</label><select id="pre-question-type"><option value="short-text">Short Text</option><option value="number">Number</option><option value="paragraph">Paragraph</option><option value="predefined-options">Predefined Options</option></select></div><div id="pre-question-options-container" class="form-group hidden"><label for="pre-question-options">Options (one per line)</label><textarea id="pre-question-options" rows="4"></textarea><div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;"><label style="margin-bottom: 0;">Search-Based Predefined Options</label><label class="switch"><input type="checkbox" id="pre-question-search-toggle"><span class="slider"></span></label></div></div><div class="actions"><button id="add-pre-question-confirm" class="btn btn-success">Add</button><button id="add-pre-question-cancel" class="btn btn-secondary">Cancel</button></div></div></div>
    <div id="excel-import-overlay" class="modal-overlay hidden"><div class="card" style="width: 98%; max-width: 1200px; max-height: 95vh; overflow-y: auto; display:flex; flex-direction: column;"><h2>Auto Arrange / Import Questions</h2><p style="font-size: 0.9em; color: #555;">Click any cell and paste your data from Excel/Sheets.</p><div class="form-group" style="display:flex; gap: 10px; margin-bottom: 10px;"><button id="ss-add-row-btn" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">+ Add Row</button><button id="ss-del-row-btn" class="btn btn-danger" style="font-size: 12px; padding: 5px 10px;">- Delete Selected Row</button></div><div class="spreadsheet-container"><table class="spreadsheet-table" id="spreadsheet-grid"><thead><tr><th style="width: 25%;">Question</th><th style="width: 10%;">Option A</th><th style="width: 10%;">Option B</th><th style="width: 10%;">Option C</th><th style="width: 10%;">Option D</th><th style="width: 10%;">Correct Option</th><th style="width: 25%;">Explanation</th></tr></thead><tbody id="spreadsheet-body"></tbody></table></div><div class="actions"><button id="process-import-btn" class="btn btn-primary">Import Questions</button><button id="cancel-import-btn" class="btn btn-secondary">Cancel</button></div></div></div>
    
    <!-- DASHBOARD VIEW -->
    <div id="quiz-dashboard" class="container">
        <div class="dashboard-header">
            <h1>My Quizzes</h1>
            <div>
                <button id="get-my-quizzes-btn" class="btn btn-secondary hidden">üîÑ Get My Quizzes</button>
                <button id="create-new-folder-btn" class="btn btn-secondary">üìÅ Create Folder</button>
                <button id="create-new-quiz-btn" class="btn btn-primary">‚ú® Create New Quiz</button>
            </div>
        </div>
        <div id="breadcrumb-trail" class="breadcrumb-trail"></div>
        <div id="dashboard-content">
            <!-- Quizzes and folders will be rendered here by JS -->
        </div>
    </div>

    <!-- BUILDER VIEW -->
    <div class="container hidden" id="quiz-builder">
        <header id="quiz-builder-header">
            <button id="back-to-dashboard-btn" class="btn btn-secondary">‚Üê Back to Dashboard</button>
            <h1 id="builder-title">Create New Quiz</h1>
            <span></span><!--spacer-->
        </header>
        <div id="quiz-settings" class="card">
            <h2>Quiz Details</h2>
            <input type="hidden" id="editing-quiz-id">
            <div class="form-group"><label for="quiz-title">Quiz Title</label><input type="text" id="quiz-title" placeholder="e.g., General Knowledge Challenge"></div>
            <div class="form-group"><label for="quiz-org">Organization Name</label><input type="text" id="quiz-org" placeholder="e.g., Global Institute"></div>
            <div class="form-group"><label for="quiz-topic">Topic</label><input type="text" id="quiz-topic" placeholder="e.g., History, Science, etc."></div>
            <div class="form-group"><label for="quiz-time">Time Limit (minutes)</label><input type="number" id="quiz-time" min="1" placeholder="e.g., 20"></div>
            
            <div class="form-group">
                <button id="manage-ads-btn" class="btn btn-secondary" style="width: 100%; margin: 0;">üì¢ Advertisement</button>
                <div id="ad-links-container"></div>
            </div>

            <div class="form-group">
                <label for="quiz-logo">Quiz Logo (Optional)</label>
                <input type="file" id="quiz-logo" accept="image/png, image/jpeg, image/gif, image/svg+xml">
                <img id="quiz-logo-preview" src="#" alt="Logo Preview"/>
            </div>

            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <label style="margin-bottom: 0;">Fixed Date and Time</label>
                <label class="switch"><input type="checkbox" id="schedule-quiz-toggle"><span class="slider"></span></label>
            </div>
            <div id="schedule-details-container" class="hidden">
                <div class="form-group"><label for="quiz-schedule-date">Quiz Start Date</label><input type="date" id="quiz-schedule-date"></div>
                <div class="form-group"><label for="quiz-schedule-time">Quiz Start Time</label><input type="time" id="quiz-schedule-time"></div>
            </div>
            <div class="form-group"><label for="quiz-terms">Upload Terms & Conditions (PDF/Image)</label><input type="file" id="quiz-terms" accept=".pdf,image/jpeg,image/png"><span id="terms-file-name" style="font-size: 12px; color: #666; margin-top: 5px; display: block;"></span></div>
            <hr>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <label style="margin-bottom: 0;">Backend Collection (With Fixed Date)</label>
                <label class="switch"><input type="checkbox" id="backend-toggle"><span class="slider"></span></label>
            </div>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <label style="margin-bottom: 0;">Backend Collection (Without Fixed Date)</label>
                <label class="switch"><input type="checkbox" id="backend-independent-toggle"><span class="slider"></span></label>
            </div>
            <div id="backend-details-container" class="hidden">
                <div class="form-group"><label for="backend-url">Google Apps Script Execution Link</label><input type="text" id="backend-url" placeholder="https://script.google.com/macros/s/..."></div>
                <p style="font-size:12px; color:#666;">Note: This is your unique link. After connecting, go to the dashboard to fetch your previously saved quizzes.</p>
                <button id="test-backend-btn" class="btn btn-secondary">Test Connection</button>
                <div id="backend-connection-status"></div>
            </div>
            <hr>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <label style="margin-bottom: 0;">Collect Candidate Information</label>
                <label class="switch"><input type="checkbox" id="collect-info-toggle"><span class="slider"></span></label>
            </div>
            <div id="pre-quiz-questions-section" class="hidden">
                <button id="add-pre-question-btn" class="btn btn-primary">‚ûï Add Question</button>
                <ul id="pre-quiz-questions-list"></ul>
            </div>
        </div>
        <div id="questions-container"><h2>Questions</h2></div>
        <div class="actions">
            <button id="add-question-btn" class="btn btn-primary">Add Question</button>
            <button id="auto-arrange-btn" class="btn btn-secondary">Auto Arrange Questions</button>
        </div>
        <hr style="margin: 40px 0; border: 1px solid #eee;">
        <div class="actions">
            <button id="preview-quiz-btn" class="btn btn-secondary">Preview Quiz</button>
            <button id="download-quiz-btn" class="btn btn-success">Download Quiz & Save</button>
        </div>
    </div>

    <!-- Player UI -->
    <div id="quiz-play-fullscreen">
        <div class="quiz-fullscreen-header">
            <div class="quiz-header-inner">
                <div class="quiz-header-top">
                    <div class="quiz-title-section">
                        <img id="player-quiz-logo" class="hidden" src="" alt="Quiz Logo">
                        <div>
                           <h2 id="preview-title"></h2>
                           <p id="preview-topic"></p>
                        </div>
                    </div>
                    <button class="exit-quiz-btn" id="exit-quiz-btn">‚Üê Exit</button>
                </div>
                <div id="quiz-timer"></div>
            </div>
        </div>
        <div class="quiz-play-content">
            <div class="quiz-play-container">
                <div class="play-left">
                    <div class="question-navigation-info"><span id="current-q-number">Question 1</span> of <span id="total-q-number">0</span></div>
                    
                    <!-- QUESTION AREA -->
                    <div class="play-question-view" id="play-question-area">
                        <!-- LOCK OVERLAY -->
                        <div id="quiz-locked-overlay" class="quiz-locked-overlay hidden"></div>

                        <div id="play-passage-section" class="play-passage-section hidden"><div class="play-passage-label">Passage / Context</div><div id="play-passage-text" class="play-question-text"></div><img id="play-passage-image" class="play-question-image hidden" src="" alt="Passage Image"></div>
                        <div class="play-question-number" id="play-q-number"></div>
                        <div class="play-question-text" id="play-q-text"></div>
                        <img class="play-question-image hidden" id="play-q-image" src="" alt="Question Image">
                        <div class="play-options-container" id="play-options"></div>
                        
                        <!-- MOBILE RESPONSIVE BUTTONS (FIXED) -->
                        <div class="play-actions">
                            <button class="btn btn-danger" id="btn-fix">Fix</button>
                            <button class="btn btn-secondary" id="btn-mark">Mark</button>
                            <div class="play-nav-buttons">
                                <button class="btn btn-primary" id="btn-prev">Prev</button>
                                <button class="btn btn-primary" id="btn-next">Next</button>
                            </div>
                        </div>
                        
                        <div id="submit-inside-card" class="submit-inside-card hidden"><button id="submit-quiz-btn" class="btn btn-success">Submit Quiz</button></div>
                    </div>
                </div>
                <!-- RIGHT SIDEBAR -->
                <div class="play-right">
                    <!-- 1. Advertisement (Top) -->
                    <div id="sidebar-ad-slot">
                        <div id="ad-side-panel" class="hidden">
                            <div class="ad-label">Advertisement</div>
                            <!-- Mount point for video -->
                            <div id="ad-video-mount"></div> 
                        </div>
                    </div>
                    
                    <!-- 2. Question Navigation (Middle) -->
                    <div class="question-panel-wrapper">
                        <div class="question-panel-header">All Questions</div>
                        <div class="question-panel" id="question-panel"></div>
                    </div>
                    
                    <!-- 3. Status Legend (Bottom) -->
                    <div class="legend"><div class="legend-title">Status:</div><span class="legend-item green">Not Answered</span><span class="legend-item red">Answered/Fixed</span><span class="legend-item yellow">Marked</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="popup-overlay" class="hidden">
        <div id="student-info-popup" class="popup-card hidden"><h2>Candidate Information</h2><div id="student-info-form-container"></div><div class="actions"><button id="submit-student-info-btn" class="btn btn-success" disabled>Continue</button></div></div>
        <div id="terms-popup" class="popup-card hidden"><h2>Terms & Conditions</h2><div id="terms-content-viewer"></div><div id="terms-agreement-section"><label class="terms-checkbox"><input type="checkbox" name="terms-check"> I have read the terms.</label><label class="terms-checkbox"><input type="checkbox" name="terms-check"> I agree to follow the quiz rules.</label><label class="terms-checkbox"><input type="checkbox" name="terms-check"> I understand that violations may lead to disqualification.</label><hr style="margin: 15px 0;"><label class="terms-checkbox mandatory"><input type="checkbox" id="terms-accept-mandatory"> <strong>I accept the Terms & Conditions.</strong></label></div><div class="actions"><button id="accept-terms-btn" class="btn btn-success" disabled>Accept & Continue</button></div></div>
        <div id="confirmation-popup" class="popup-card hidden" style="max-width: 450px;"><h2 id="confirmation-title">Ready to Go!</h2><p id="confirmation-message" style="text-align: center; font-size: 18px; margin: 20px 0;">Best of luck! You can now start your quiz.</p><div id="quiz-start-countdown"></div><div class="actions"><button id="start-quiz-now-btn" class="btn btn-primary">Start Quiz Now</button></div></div>
    </div>
    
    <!-- Initial Overlay for Ads and Play Start -->
    <div id="ad-start-overlay" class="hidden">
        <h1 id="ad-start-title">Welcome</h1>
        <p id="ad-start-desc">Click below to begin.</p>
        <button id="ad-start-btn" class="btn btn-primary" style="font-size: 20px; padding: 15px 30px;">Start Quiz</button>
    </div>
    
    <div id="special-char-popup" class="hidden"></div>

    <script>
    // --- LOAD YOUTUBE API ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var ytPlayer;
    var ytApiReady = false;
    function onYouTubeIframeAPIReady() { ytApiReady = true; }

    // --- SELF-CONTAINED PLAYER LOGIC ---
    function initializePlayer(QUIZ_DATA) {
        let playState = { 
            index: 0, 
            questions: [], 
            timerInterval: null, 
            studentInfo: {}, 
            startTime: new Date().toISOString(), 
            adIndex: 0,
            popupAdIndex: 0,
            isYoutubePlaying: false,
            youtubeAds: [], // Specific list for sidebar (YT only)
            popupAds: [], // Specific list for popups (Non-YT only)
            volTimer: null,
            adLocked: false, // NEW LOCK STATE
            ...QUIZ_DATA 
        };
        let countdownInterval;

        // SEPARATE AD LINKS (STRICT FILTERING)
        function getYouTubeID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        if(playState.advertisementLinks) {
            playState.youtubeAds = playState.advertisementLinks.filter(link => getYouTubeID(link));
            playState.popupAds = playState.advertisementLinks.filter(link => !getYouTubeID(link));
        }

        // --- VOLUME DYNAMICS ---
        function startVolumeDynamics() {
            if(!ytPlayer) return;
            let time = 0;
            if(playState.volTimer) clearInterval(playState.volTimer);
            
            ytPlayer.setVolume(1); // Start Low
            playState.volTimer = setInterval(() => {
                time++;
                if (time === 30) ytPlayer.setVolume(20); // 30s -> Med
                if (time === 120) ytPlayer.setVolume(60); // 2m -> High
                if (time === 360) { // 6m -> Low Loop
                    ytPlayer.setVolume(1);
                    time = 0;
                }
            }, 1000);
        }

        // --- SIDE PANEL AD LOGIC (YOUTUBE ONLY) ---
        function loadSideAd(requireInteraction = false) {
            const container = document.getElementById('ad-side-panel');
            const mount = document.getElementById('ad-video-mount');
            
            if (!playState.youtubeAds || playState.youtubeAds.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            if (!ytApiReady) {
                setTimeout(() => loadSideAd(requireInteraction), 100);
                return;
            }

            let currentLink = playState.youtubeAds[playState.adIndex];
            const ytID = getYouTubeID(currentLink);

            if (ytID) {
                // If player exists, just load new video
                if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
                    if (requireInteraction) {
                         ytPlayer.loadVideoById(ytID);
                         ytPlayer.stopVideo(); // Stop and wait for user click
                         startVolumeDynamics();
                         playState.adLocked = true; // Set Lock on new video load
                         toggleQuizLock(true);
                    }
                } else {
                    // Create Player
                    const divId = 'yt-player-' + Date.now();
                    mount.innerHTML = `<div class="video-container"><div id="${divId}"></div></div>`;

                    ytPlayer = new YT.Player(divId, {
                        height: '100%',
                        width: '100%',
                        videoId: ytID,
                        host: 'https://www.youtube.com',
                        playerVars: { 
                            'playsinline': 1, 
                            'autoplay': 0, // NO AUTOPLAY
                            'controls': 1,
                            'origin': window.location.origin,
                            'rel': 0,
                            'modestbranding': 1,
                            'enablejsapi': 1
                        },
                        events: {
                            'onReady': (event) => {
                                event.target.setVolume(1);
                            },
                            'onStateChange': (event) => {
                                // PLAYING (1) or BUFFERING (3) means user interacted
                                if (event.data == YT.PlayerState.PLAYING || event.data == YT.PlayerState.BUFFERING) {
                                    playState.isYoutubePlaying = true;
                                    
                                    // UNLOCK QUIZ IMMEDIATELY ON PLAY
                                    if(playState.adLocked) {
                                        playState.adLocked = false;
                                        toggleQuizLock(false);
                                    }
                                    
                                    startVolumeDynamics();
                                } else if (event.data == YT.PlayerState.ENDED) {
                                    playState.isYoutubePlaying = false;
                                    playState.adIndex = (playState.adIndex + 1) % playState.youtubeAds.length;
                                    clearInterval(playState.volTimer);
                                    
                                    // Flag next video to require interaction
                                    playState.adLocked = true; 
                                } else if (event.data == YT.PlayerState.PAUSED) {
                                    playState.isYoutubePlaying = false;
                                }
                            }
                        }
                    });
                }
            } 
        }
        
        function toggleQuizLock(isLocked) {
            const overlay = document.getElementById('quiz-locked-overlay');
            if(isLocked) {
                overlay.classList.remove('hidden');
                // Bind toast click event
                overlay.onclick = () => {
                    const toast = document.getElementById('ad-toast');
                    toast.className = "show";
                    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 5000);
                }
            } else {
                overlay.classList.add('hidden');
                overlay.onclick = null;
            }
        }

        // --- POP-UP AD LOGIC (Start Button - NON-YOUTUBE ONLY) ---
        function executeAdStrategy() {
            if (!playState.popupAds || playState.popupAds.length === 0) return;
            
            const quizKey = 'ads_popup_' + (playState.quizId || playState.quizTitle.replace(/\s/g,''));
            const now = Date.now();
            let adState = JSON.parse(localStorage.getItem(quizKey)) || { currentIndex: 0, cycleCompleteTime: 0 };

            if (adState.cycleCompleteTime > 0) {
                const msPassed = now - adState.cycleCompleteTime;
                const hoursPassed = msPassed / (1000 * 60 * 60);
                if (hoursPassed < 24) { return; } 
                else { adState.currentIndex = 0; adState.cycleCompleteTime = 0; }
            }

            if (adState.currentIndex >= playState.popupAds.length) adState.currentIndex = 0;

            const linkToOpen = playState.popupAds[adState.currentIndex];
            
            if (linkToOpen) {
                const win = window.open(linkToOpen, '_blank');
                if(!win) { alert("Please allow popups to start this quiz properly."); window.open(linkToOpen, '_blank'); }
                
                adState.currentIndex++;
                if (adState.currentIndex >= playState.popupAds.length) { adState.cycleCompleteTime = now; }
                localStorage.setItem(quizKey, JSON.stringify(adState));
            }
        }
        
        const adStartOverlay = document.getElementById('ad-start-overlay');
        const adStartBtn = document.getElementById('ad-start-btn');
        const dashboard = document.getElementById('quiz-dashboard');
        
        const isStudentView = document.body.classList.contains('student-view');
        const isStandalone = !document.getElementById('quiz-builder') || document.getElementById('quiz-builder').classList.contains('hidden');

        if((isStandalone || isStudentView)) {
            if(dashboard) dashboard.classList.add('hidden');
            adStartOverlay.classList.remove('hidden');
            
            adStartBtn.onclick = () => {
                executeAdStrategy();
                adStartOverlay.classList.add('hidden');
                startQuizFlow();
                setTimeout(() => loadSideAd(false), 500); 
            };
        } else {
            startQuizFlow();
        }
        // --- SIDE PANEL AD LOGIC END ---

        const playerLogoEl = document.getElementById('player-quiz-logo');
        if (playState.logoSrc) {
            playerLogoEl.src = playState.logoSrc;
            playerLogoEl.classList.remove('hidden');
        } else {
            playerLogoEl.classList.add('hidden');
        }

        const toLetter = (num) => String.fromCharCode(65 + num);
        function formatTimeDifference(ms) { if (ms < 0) ms = 0; let s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60), d = Math.floor(h / 24); h %= 24; m %= 60; s %= 60; let parts = []; if (d > 0) parts.push(`${d} day${d > 1 ? 's' : ''}`); if (h > 0) parts.push(`${h} hour${h > 1 ? 's' : ''}`); if (m > 0) parts.push(`${m} minute${m > 1 ? 's' : ''}`); if (s > 0 || parts.length === 0) parts.push(`${s} second${s > 1 ? 's' : ''}`); return parts.join(', '); }
        function updateTimerDisplay(seconds) { const minutes = Math.floor(seconds / 60); const secs = seconds % 60; document.getElementById('quiz-timer').textContent = `Time: ${minutes}:${secs.toString().padStart(2, '0')}`; }
        function sendResultsToBackend(payload) { if (!playState.backendUrl || !playState.backendSheetId) { console.log("Backend details (URL or Sheet ID) missing. Skipping submission."); return; } console.log("Sending results to backend..."); fetch(playState.backendUrl, { method: 'POST', mode: 'no-cors', cache: 'no-cache', redirect: 'follow', body: JSON.stringify(payload) }).then(() => { console.log("Result data sent to backend."); }).catch(err => { console.error("Error sending results to backend:", err); }); }
        function renderPlayQuestion() { const q = playState.questions[playState.index]; document.getElementById('current-q-number').textContent = `Question ${playState.index + 1}`; document.getElementById('play-q-number').textContent = `Question ${q.questionNumber}.`; const passageSection = document.getElementById('play-passage-section'), passageTextEl = document.getElementById('play-passage-text'), passageImageEl = document.getElementById('play-passage-image'); if (q.passageData && q.passageData.content) { passageSection.classList.remove('hidden'); if (q.passageData.type === 'image') { passageTextEl.innerHTML = ''; passageImageEl.src = q.passageData.content; passageImageEl.classList.remove('hidden'); } else { passageTextEl.innerHTML = q.passageData.content; passageImageEl.classList.add('hidden'); } } else { passageSection.classList.add('hidden'); } const qTextEl = document.getElementById('play-q-text'), qImageEl = document.getElementById('play-q-image'); if (q.type === 'image-mcq' && q.imageSrc) { qTextEl.innerHTML = ''; qImageEl.src = q.imageSrc; qImageEl.classList.remove('hidden'); } else { qTextEl.innerHTML = q.text || ''; qImageEl.classList.add('hidden'); } const optionsContainer = document.getElementById('play-options'); optionsContainer.innerHTML = ''; if (q.type === 'short-answer') { const input = document.createElement('input'); input.type = 'text'; input.placeholder = 'Type your answer here'; input.value = q.userAnswer || ''; input.style.cssText = 'width: 100%; padding: 12px; font-size: 15px; border: 2px solid #ddd; border-radius: 8px;'; input.disabled = q.fixed; input.addEventListener('input', (e) => { q.userAnswer = e.target.value; q.selectedOption = e.target.value ? 0 : null; if (q.marked && e.target.value) q.marked = false; renderQuestionPanel(); }); optionsContainer.appendChild(input); } else { q.options.forEach((opt, i) => { const div = document.createElement('div'); div.className = 'play-option'; if (q.selectedOption === i) div.classList.add('selected'); if (q.fixed) div.classList.add('disabled'); div.innerHTML = `<span class="option-label">${q.isSubQuestion ? `${i + 1}.` : `${toLetter(i)}.`}</span><div class="option-text">${opt}</div>`; div.onclick = () => { if (q.fixed) return; q.selectedOption = i; if (q.marked) q.marked = false; renderPlayQuestion(); renderQuestionPanel(); }; optionsContainer.appendChild(div); }); } document.getElementById('btn-fix').disabled = q.fixed || q.selectedOption === null; document.getElementById('btn-mark').textContent = q.marked ? 'Unmark' : 'Mark'; document.getElementById('btn-prev').disabled = playState.index === 0; const btnNext = document.getElementById('btn-next'); btnNext.textContent = playState.index === playState.questions.length - 1 ? 'Last' : 'Next'; btnNext.disabled = playState.index === playState.questions.length - 1; document.getElementById('submit-inside-card').classList.toggle('hidden', playState.index !== playState.questions.length - 1); }
        function renderQuestionPanel() { const panelEl = document.getElementById('question-panel'); panelEl.innerHTML = ''; playState.questions.forEach((q, idx) => { const chip = document.createElement('div'); chip.className = 'q-chip'; if (q.marked) chip.classList.add('yellow'); else if (q.selectedOption !== null || q.fixed) chip.classList.add('red'); else chip.classList.add('green'); if (idx === playState.index) chip.classList.add('active'); chip.textContent = idx + 1; chip.title = `Question ${idx + 1}`; chip.onclick = () => { playState.index = idx; renderPlayQuestion(); renderQuestionPanel(); }; panelEl.appendChild(chip); }); }
        
        function showResults() { if (countdownInterval) clearInterval(countdownInterval); if(playState.timerInterval) clearInterval(playState.timerInterval); let score = 0, answeredCount = 0; const totalQuestions = playState.questions.length; playState.questions.forEach((q) => { let isAnswered = false, isCorrect = null; if (q.type === 'short-answer') { if (q.userAnswer) { isAnswered = true; isCorrect = q.userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase(); } } else if (q.selectedOption !== null) { isAnswered = true; isCorrect = q.selectedOption === q.correctIndex; } if (isAnswered) answeredCount++; if (isCorrect) score++; q.userCorrect = isCorrect; }); if (playState.backendUrl && playState.backendSheetId && (playState.scheduledDateTime || playState.isIndependentBackend)) { const htmlToPlainText = (html) => { if (!html) return ""; const tempDiv = document.createElement('div'); html = html.replace(/<\/td>/g, ' | ').replace(/<\/tr>/g, '\n'); tempDiv.innerHTML = html; return tempDiv.textContent || tempDiv.innerText || ""; }; const sanitizedQuestions = playState.questions.map(q => ({ ...q, text: htmlToPlainText(q.text), options: q.options.map(opt => htmlToPlainText(opt)), passageData: q.passageData ? { ...q.passageData, content: q.passageData.type === 'text' ? htmlToPlainText(q.passageData.content) : q.passageData.content } : null })); const backendPayload = { action: 'submit', sheetId: playState.backendSheetId, candidateInfo: playState.studentInfo, questions: sanitizedQuestions, summary: { score: score, total: totalQuestions, submissionTime: new Date().toISOString() } }; sendResultsToBackend(backendPayload); } const percentage = totalQuestions > 0 ? ((score / totalQuestions) * 100).toFixed(1) : 0; let studentInfoHTML = ''; if (playState.studentInfo && Object.keys(playState.studentInfo).length > 0) { studentInfoHTML = `<div class="student-info-results"><h2>Candidate Information</h2>`; Object.entries(playState.studentInfo).forEach(([key, value]) => { studentInfoHTML += `<div class="quiz-info-row"><span class="quiz-info-label">${key}:</span><span>${value}</span></div>`; }); studentInfoHTML += `</div>`; } let questionsResultHTML = ''; playState.questions.forEach((q, idx) => { let questionHTML = `<div class="result-question">`; if (q.passageData && q.passageData.content) { questionHTML += `<div class="result-passage"><strong>Passage/Context:</strong><br>${q.passageData.type === 'image' ? `<img src="${q.passageData.content}" class="result-question-image" alt="Passage">` : q.passageData.content}</div>`; } questionHTML += `<div class="result-question-header">Question ${q.questionNumber}</div>`; if (q.type === 'image-mcq' && q.imageSrc) { questionHTML += `<img src="${q.imageSrc}" class="result-question-image" alt="Question">`; } else if (q.text) { questionHTML += `<div class="result-question-text">${q.text}</div>`; } if (q.type === 'short-answer') { questionHTML += `<div style="margin: 15px 0;"><p><strong>Your Answer:</strong> ${q.userAnswer || '<em>Not answered</em>'}</p><p><strong>Correct Answer:</strong> <span style="color: #28a745;">${q.answer}</span></p></div>`; } else { questionHTML += `<div class="result-options">`; q.options.forEach((opt, i) => { let optClass = i === q.correctIndex ? 'correct' : (i === q.selectedOption ? 'wrong' : ''); const optionLabel = `<strong>${q.isSubQuestion ? `${i + 1}.` : `${toLetter(i)}.`}</strong>`; let content = `<div class="result-option ${optClass}">${optionLabel} <div class="option-text">${opt}</div>`; if (i === q.selectedOption && i !== q.correctIndex) content += '<em>(Your choice)</em>'; content += `</div>`; questionHTML += content; }); questionHTML += `</div>`; } let statusClass = q.userCorrect === null ? 'not-answered' : (q.userCorrect ? 'correct-answer' : 'wrong-answer'); let statusText = q.userCorrect === null ? 'Not Answered' : (q.userCorrect ? '‚úì Correct' : '‚úó Incorrect'); questionHTML += `<div class="result-status ${statusClass}">${statusText}</div>`; if(q.explanation && q.explanation.trim() !== "") { questionHTML += `<div class="result-explanation"><strong>Explanation:</strong><br>${q.explanation}</div>`; } questionHTML += `</div>`; questionsResultHTML += questionHTML; }); 
        
        let actionButtons = `<button id="print-results-btn" class="btn btn-primary" style="font-size: 18px; padding: 15px 40px;">üñ®Ô∏è Print Results</button>`;
        if (!playState.scheduledDateTime) { actionButtons += `<button id="retake-quiz-btn" class="btn btn-secondary" style="font-size: 18px; padding: 15px 40px;">‚Ü∫ Retake Quiz</button>`; }
        if(document.getElementById('quiz-dashboard')) { actionButtons += `<button onclick="location.reload()" class="btn btn-primary" style="font-size: 18px; padding: 15px 40px;">‚Üê Back to Menu</button>`; }

        const resultsHTML = `<div class="results-container"><div class="results-header"><h1>üìä Quiz Results</h1><p>Detailed Report</p></div>${studentInfoHTML}<div class="quiz-info"><div class="quiz-info-row"><span class="quiz-info-label">Quiz Title:</span><span>${playState.quizTitle}</span></div><div class="quiz-info-row"><span class="quiz-info-label">Organization:</span><span>${playState.organization || 'N/A'}</span></div><div class="quiz-info-row"><span class="quiz-info-label">Topic:</span><span>${playState.quizTopic}</span></div><div class="quiz-info-row"><span class="quiz-info-label">Total Questions:</span><span>${totalQuestions}</span></div><div class="quiz-info-row"><span class="quiz-info-label">Time Limit:</span><span>${playState.timeLimit > 0 ? playState.timeLimit + ' minutes' : 'No limit'}</span></div><div class="quiz-info-row"><span class="quiz-info-label">Date:</span><span>${new Date().toLocaleDateString()}</span></div></div><div class="score-summary"><h2 style="margin: 0;">Your Score</h2><div class="big-score">${score} / ${totalQuestions}</div><div class="percentage">${percentage}%</div><p>Answered: ${answeredCount} | Not Answered: ${totalQuestions - answeredCount}</p></div><div class="detailed-results"><h2>Detailed Answer Key</h2>${questionsResultHTML}</div><div class="print-actions">${actionButtons}</div></div>`; document.querySelector('.quiz-play-content').innerHTML = resultsHTML; 
        document.getElementById('print-results-btn').addEventListener('click', () => window.print()); 
        if(!playState.scheduledDateTime) { document.getElementById('retake-quiz-btn').addEventListener('click', () => location.reload()); }
    }

    function actuallyStartTheQuiz() { document.getElementById('popup-overlay').classList.add('hidden'); document.getElementById('preview-title').textContent = playState.quizTitle; document.getElementById('preview-topic').textContent = `Topic: ${playState.quizTopic}`; document.title = playState.quizTitle; document.getElementById('quiz-play-fullscreen').style.display = 'block'; document.body.style.overflow = 'hidden'; if (playState.scheduledDateTime && playState.timeLimit > 0) { const startTime = new Date(playState.scheduledDateTime).getTime(); const quizEndTime = startTime + (playState.timeLimit * 60 * 1000); document.getElementById('quiz-timer').style.display = 'block'; playState.timerInterval = setInterval(() => { const now = new Date().getTime(); const timeRemaining = Math.round((quizEndTime - now) / 1000); if (timeRemaining <= 0) { updateTimerDisplay(0); clearInterval(playState.timerInterval); showResults(); } else { updateTimerDisplay(timeRemaining); } }, 1000); } else if (playState.timeLimit > 0) { let timeRemaining = playState.timeLimit * 60; document.getElementById('quiz-timer').style.display = 'block'; updateTimerDisplay(timeRemaining); playState.timerInterval = setInterval(() => { timeRemaining--; updateTimerDisplay(timeRemaining); if (timeRemaining <= 0) { clearInterval(playState.timerInterval); showResults(); } }, 1000); } else { document.getElementById('quiz-timer').style.display = 'none'; } document.getElementById('total-q-number').textContent = playState.questions.length; renderPlayQuestion(); renderQuestionPanel(); }
    function setupAndShowConfirmation(onComplete) { const popupOverlay = document.getElementById('popup-overlay'), confirmationPopup = document.getElementById('confirmation-popup'); const titleEl = document.getElementById('confirmation-title'), msgEl = document.getElementById('confirmation-message'), countdownEl = document.getElementById('quiz-start-countdown'), startBtn = document.getElementById('start-quiz-now-btn'); popupOverlay.classList.remove('hidden'); confirmationPopup.classList.remove('hidden'); if (countdownInterval) clearInterval(countdownInterval); if (playState.scheduledDateTime) { const startTime = new Date(playState.scheduledDateTime).getTime(); const endTime = playState.timeLimit > 0 ? startTime + (playState.timeLimit * 60 * 1000) : 0; const updateView = () => { const now = new Date().getTime(); if (endTime > 0 && now >= endTime) { clearInterval(countdownInterval); titleEl.textContent = "Quiz Over"; msgEl.textContent = "This quiz has already ended."; countdownEl.style.display = 'none'; startBtn.disabled = true; } else if (now >= startTime) { clearInterval(countdownInterval); titleEl.textContent = "Quiz in Progress"; msgEl.textContent = "The quiz has started. Join now!"; countdownEl.style.display = 'none'; startBtn.disabled = false; } else { titleEl.textContent = "Quiz is Scheduled"; msgEl.textContent = `The quiz will begin at: ${new Date(startTime).toLocaleString()}`; startBtn.disabled = true; countdownEl.style.display = 'block'; const timeLeft = startTime - now; if (timeLeft <= 30000) { clearInterval(countdownInterval); onComplete(); } else { countdownEl.textContent = `Starts in: ${formatTimeDifference(timeLeft)}`; } } }; countdownInterval = setInterval(updateView, 1000); updateView(); } else { titleEl.textContent = "Ready to Go!"; msgEl.textContent = "Best of luck! You can now start your quiz."; startBtn.disabled = false; startBtn.textContent = "Start Quiz Now"; countdownEl.style.display = 'none'; } startBtn.onclick = () => { if (countdownInterval) clearInterval(countdownInterval); onComplete(); }; }
    function setupAndShowTermsPopup(onComplete) { const popupOverlay = document.getElementById('popup-overlay'), termsPopup = document.getElementById('terms-popup'); const showConfirmationStep = () => { termsPopup.classList.add('hidden'); setupAndShowConfirmation(onComplete); }; const viewer = document.getElementById('terms-content-viewer'); viewer.innerHTML = ''; if (playState.terms.type.startsWith('image/')) { viewer.innerHTML = `<img src="${playState.terms.content}" alt="Terms and Conditions">`; } else if (playState.terms.type === 'application/pdf') { viewer.innerHTML = `<iframe src="${playState.terms.content}#toolbar=0" type="application/pdf"></iframe>`; } const checkboxes = termsPopup.querySelectorAll('input[type="checkbox"]'), acceptBtn = document.getElementById('accept-terms-btn'); checkboxes.forEach(cb => cb.checked = false); acceptBtn.disabled = true; const checkHandler = () => { acceptBtn.disabled = ![...checkboxes].every(cb => cb.checked); }; checkboxes.forEach(cb => cb.addEventListener('change', checkHandler)); acceptBtn.onclick = showConfirmationStep; popupOverlay.classList.remove('hidden'); termsPopup.classList.remove('hidden'); document.getElementById('confirmation-popup').classList.add('hidden'); }
    function setupAndShowStudentInfoPopup(onComplete) { const popupOverlay = document.getElementById('popup-overlay'), studentInfoPopup = document.getElementById('student-info-popup'), formContainer = document.getElementById('student-info-form-container'), submitBtn = document.getElementById('submit-student-info-btn'); formContainer.innerHTML = ''; playState.preQuizQuestions.forEach((q, index) => { let fieldHTML = `<div class="form-group"><label for="pre-q-${index}">${q.label}</label>`; if (q.type === 'predefined-options' && q.useSearch) { fieldHTML += `<input type="text" id="pre-q-${index}" data-label="${q.label}" required data-is-search="true" data-status-id="pre-q-status-${index}" autocomplete="off"><div id="pre-q-status-${index}" class="pre-quiz-search-status"></div>`; } else { switch (q.type) { case 'number': fieldHTML += `<input type="number" id="pre-q-${index}" data-label="${q.label}" required>`; break; case 'paragraph': fieldHTML += `<textarea id="pre-q-${index}" data-label="${q.label}" rows="3" required></textarea>`; break; case 'predefined-options': fieldHTML += `<select id="pre-q-${index}" data-label="${q.label}" required><option value="">-- Please select --</option>`; q.options.forEach(opt => { fieldHTML += `<option value="${opt}">${opt}</option>`; }); fieldHTML += `</select>`; break; default: fieldHTML += `<input type="text" id="pre-q-${index}" data-label="${q.label}" required>`; break; } } fieldHTML += `</div>`; formContainer.innerHTML += fieldHTML; }); const inputs = formContainer.querySelectorAll('input[required], textarea[required], select[required]'); const checkValidity = () => { submitBtn.disabled = ![...inputs].every(i => { if (i.dataset.isSearch) { const statusEl = document.getElementById(i.dataset.statusId); return statusEl && statusEl.textContent === 'TRUE'; } else { return i.value.trim() !== ''; } }); }; inputs.forEach(i => { if (i.dataset.isSearch) { const statusEl = document.getElementById(i.dataset.statusId); const questionData = playState.preQuizQuestions[parseInt(i.id.split('-')[2], 10)]; const validOptions = questionData.options.map(o => o.toLowerCase()); i.addEventListener('input', () => { const typedValue = i.value.trim().toLowerCase(); if (typedValue === '') { statusEl.textContent = ''; statusEl.className = 'pre-quiz-search-status'; } else if (validOptions.includes(typedValue)) { statusEl.textContent = 'TRUE'; statusEl.className = 'pre-quiz-search-status status-true'; } else { statusEl.textContent = 'Not Found'; statusEl.className = 'pre-quiz-search-status status-false'; } checkValidity(); }); } else { i.addEventListener('input', checkValidity); } }); submitBtn.onclick = () => { inputs.forEach(i => { playState.studentInfo[i.dataset.label] = i.value; }); studentInfoPopup.classList.add('hidden'); onComplete(); }; popupOverlay.classList.remove('hidden'); studentInfoPopup.classList.remove('hidden'); checkValidity(); }
    
    function startQuizFlow() { 
        document.querySelectorAll('#quiz-dashboard, #quiz-builder').forEach(el => el.classList.add('hidden')); 
        const hasInfoQuestions = playState.preQuizQuestions && playState.preQuizQuestions.length > 0; 
        const hasTerms = playState.terms && playState.terms.content; 
        const nextStep = () => { if (hasTerms) { setupAndShowTermsPopup(actuallyStartTheQuiz); } else { setupAndShowConfirmation(actuallyStartTheQuiz); } }; 
        if (hasInfoQuestions) { setupAndShowStudentInfoPopup(nextStep); } else { nextStep(); } 
    }
    
    document.getElementById('btn-prev').addEventListener('click', () => { if (playState.index > 0) { playState.index--; renderPlayQuestion(); renderQuestionPanel(); } });
    
    // --- UPDATED NEXT BUTTON LOGIC ---
    document.getElementById('btn-next').addEventListener('click', () => { 
        if (playState.index < playState.questions.length - 1) { 
            
            // Check Trigger for 1st Question (Index 0 -> 1)
            const isTriggerPoint = (playState.index === 0); 
            
            // Proceed to next question
            playState.index++; 
            renderPlayQuestion(); 
            renderQuestionPanel();
            
            // Determine Lock State for Next Question
            if (ytPlayer && typeof ytPlayer.getPlayerState === 'function') {
                const state = ytPlayer.getPlayerState();
                
                // If this is Q2 (Trigger Point) OR if Video has Ended (Queueing new one)
                // We lock the UI immediately upon navigation
                if (isTriggerPoint || playState.adLocked) {
                    // Check if NOT playing or buffering (i.e. user needs to click)
                    if (state !== YT.PlayerState.PLAYING && state !== YT.PlayerState.BUFFERING) {
                        toggleQuizLock(true); // LOCK UI
                        
                        // If ended, load new one
                        if (state === YT.PlayerState.ENDED) {
                            loadSideAd(true);
                        }
                    }
                }
            } else if (isTriggerPoint) {
                // If API not ready yet but trigger hit
                toggleQuizLock(true);
                loadSideAd(true);
            }
        } 
    });
    
    document.getElementById('btn-fix').addEventListener('click', () => { const q = playState.questions[playState.index]; if (q.selectedOption !== null && !q.fixed) { q.fixed = true; renderPlayQuestion(); renderQuestionPanel(); } });
    document.getElementById('btn-mark').addEventListener('click', () => { const q = playState.questions[playState.index]; q.marked = !q.marked; renderPlayQuestion(); renderQuestionPanel(); });
    document.getElementById('submit-quiz-btn').addEventListener('click', () => { showResults(); });
    const exitBtn = document.getElementById('exit-quiz-btn'); if(exitBtn) { exitBtn.addEventListener('click', () => location.reload()); }
    
    }
    
    // --- RTE & BUILDER SCRIPT ---
    const createRichTextEditor = (container, placeholderText = 'Enter text here...') => { const fontList = ["Arial", "Verdana", "Times New Roman", "Georgia", "Courier New", "Cursive"]; let toolbarHTML = ` <select class="rte-font-family" title="Font Style"><option>Font</option>${fontList.map(f => `<option value="${f}">${f}</option>`).join('')}</select> <select class="rte-font-size" title="Font Size"> <option value="1">1 (8pt)</option><option value="2">2 (10pt)</option><option value="3" selected>3 (12pt)</option><option value="4">4 (14pt)</option><option value="5">5 (18pt)</option><option value="6">6 (24pt)</option><option value="7">7 (36pt)</option> </select> <div class="rte-separator"></div> <button data-command="bold" title="Bold"><b>B</b></button> <button data-command="italic" title="Italic"><i>I</i></button> <button data-command="underline" title="Underline"><u>U</u></button> <div class="rte-separator"></div> <button data-command="insertUnorderedList" title="Bullet List">‚óè</button> <button data-command="insertOrderedList" title="Numbered List">1.</button><div class="rte-separator"></div> <button data-command="removeFormat" title="Remove Formatting">‚å´</button> `; const toolbar = document.createElement('div'); toolbar.className = 'rte-toolbar'; toolbar.innerHTML = toolbarHTML; const content = document.createElement('div'); content.className = 'rte-content'; content.contentEditable = true; content.dataset.placeholder = placeholderText; container.classList.add('rte-container'); container.appendChild(toolbar); container.appendChild(content); toolbar.querySelectorAll('button[data-command]').forEach(button => { button.addEventListener('mousedown', (e) => { e.preventDefault(); const command = e.currentTarget.dataset.command; content.focus(); document.execCommand(command, false, null); }); }); toolbar.querySelectorAll('select, input[type="color"]').forEach(input => { input.addEventListener('change', (e) => { const command = e.currentTarget.dataset.command || e.currentTarget.className.split('-')[1]; const value = e.currentTarget.value; content.focus(); document.execCommand(command, false, value); }); }); };

    // --- DASHBOARD & BUILDER APP LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        const quizDashboard = document.getElementById('quiz-dashboard');
        const quizBuilder = document.getElementById('quiz-builder');
        const dashboardContent = document.getElementById('dashboard-content');
        const breadcrumbTrail = document.getElementById('breadcrumb-trail');
        const loadingScreen = document.getElementById('student-loading');
        let currentPath = []; // Array of folder IDs
        let clipboard = null; // For copy/paste

        // --- DATA MANAGEMENT ---
        const getDb = () => JSON.parse(localStorage.getItem('quizDashboardDB_v4')) || { items: [] };
        const saveDb = (db) => localStorage.setItem('quizDashboardDB_v4', JSON.stringify(db));
        
        function findItem(itemId, db = getDb()) {
            let found = null;
            function search(items) {
                if (!items) return;
                for (const item of items) {
                    if (item.id === itemId) { found = item; return; }
                    if (item.type === 'folder' && item.items) search(item.items);
                }
            }
            search(db.items);
            return found;
        }

        function findParent(itemId, db) {
            if (db.items.some(i => i.id === itemId)) return db;
            function search(currentParent) {
                if (!currentParent.items) return null;
                for (const item of currentParent.items) {
                    if (item.type === 'folder' && item.items) {
                        if (item.items.some(child => child.id === itemId)) { return item; }
                        const result = search(item);
                        if (result) return result;
                    }
                }
                return null;
            }
            return search({ items: db.items });
        }
        
        async function syncToBackend() {
            const backendUrl = localStorage.getItem('quiz_backend_url');
            if (!backendUrl) return;

            const db = getDb();
            const folders = [];
            const quizLocations = [];

            function traverse(items, parentId) {
                if (!items) return;
                items.forEach(item => {
                    if (item.type === 'folder') {
                        folders.push({ id: item.id, name: item.name, parentId: parentId });
                        if (item.items) traverse(item.items, item.id);
                    } else if (item.type === 'quiz' && item.backendSheetId) {
                        quizLocations.push({ sheetId: item.backendSheetId, parentId: parentId });
                    }
                });
            }
            traverse(db.items, 'root');

            try {
                await fetch(backendUrl, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    body: JSON.stringify({ action: 'sync_structure', folders: folders, quizLocations: quizLocations })
                });
                console.log("Structure synced to backend.");
            } catch (e) { console.error("Sync failed:", e); }
        }

        const showDashboard = () => {
            quizDashboard.classList.remove('hidden');
            quizBuilder.classList.add('hidden');
            document.title = "Quiz Test Maker Dashboard";
            renderDashboard();
        };

        const showBuilder = (quizId = null) => {
            quizDashboard.classList.add('hidden');
            quizBuilder.classList.remove('hidden');
            resetBuilder();

            if (quizId) {
                const quiz = findItem(quizId);
                if (quiz && quiz.type === 'quiz') {
                    if(quiz.data) {
                        document.getElementById('builder-title').textContent = `Editing: ${quiz.name}`;
                        document.getElementById('editing-quiz-id').value = quizId;
                        populateBuilder(quiz.data);
                    } else if (quiz.backendSheetId) {
                        alert("Fetching quiz data for editing...");
                        fetchBackendQuizData(quiz.backendSheetId).then(data => {
                            if(data) {
                                document.getElementById('builder-title').textContent = `Editing: ${quiz.name}`;
                                document.getElementById('editing-quiz-id').value = quizId;
                                populateBuilder(data);
                            } else {
                                showDashboard();
                            }
                        });
                    }
                }
            } else {
                document.getElementById('builder-title').textContent = 'Create New Quiz';
                createQuestionCard(); 
            }
        };

        async function fetchBackendQuizData(sheetId, explicitBackendUrl = null) {
            const backendUrl = explicitBackendUrl || localStorage.getItem('quiz_backend_url');
            if(!backendUrl) return null;
            try {
                const res = await fetch(backendUrl, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    body: JSON.stringify({ action: 'get_quiz_data', sheetId: sheetId })
                });
                const result = await res.json();
                if(result.status === 'success') return result.quizData;
                alert(result.message);
                return null;
            } catch(e) {
                alert("Fetch error: " + e);
                return null;
            }
        }
        
        async function fetchAllBackendData(explicitBackendUrl) {
             try {
                const response = await fetch(explicitBackendUrl, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    body: JSON.stringify({ action: 'get_all_data' }),
                });
                const result = await response.json();
                if (result.status === 'success') {
                    const newDb = { items: [] };
                    const itemMap = new Map();
                    itemMap.set('root', newDb);

                    if(result.folders) {
                        result.folders.forEach(f => {
                            if (!itemMap.has(f.id)) {
                                const folder = { id: f.id, type: 'folder', name: f.name, items: [] };
                                itemMap.set(f.id, folder);
                            }
                        });
                        result.folders.forEach(f => {
                            const folder = itemMap.get(f.id);
                            const parent = itemMap.get(f.parentId) || itemMap.get('root');
                            if(parent && !parent.items.some(i => i.id === f.id)) {
                                parent.items.push(folder);
                            }
                        });
                    }
                    result.quizzes.forEach(quiz => {
                        const parentId = quiz.parentId || 'root';
                        const parent = itemMap.get(parentId) || itemMap.get('root');
                        if (parent) {
                            const quizItem = {
                                id: `backend_${quiz.sheetId}`,
                                type: 'quiz', name: quiz.name, backendSheetId: quiz.sheetId, data: null 
                            };
                            if (!parent.items.some(i => i.id === quizItem.id)) {
                                parent.items.push(quizItem);
                            }
                        }
                    });
                    saveDb(newDb); 
                    return result; 
                }
                return false;
             } catch(e) { console.error(e); return false; }
        }

        function renderDashboard() {
            const db = getDb();
            let currentFolder = db;
            let pathHTML = '<a href="#" data-folder-id="root">Home</a>';
            
            currentPath.forEach(folderId => {
                const folder = findItem(folderId, db);
                if (folder) {
                    currentFolder = folder;
                    pathHTML += `<span>&gt;</span><a href="#" data-folder-id="${folderId}">${folder.name}</a>`;
                }
            });
            breadcrumbTrail.innerHTML = pathHTML;
            
            dashboardContent.innerHTML = '';
            if (!currentFolder.items || currentFolder.items.length === 0) {
                dashboardContent.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #888;">This folder is empty. Create a quiz or use "Get My Quizzes" if connected.</p>';
                return;
            }
            
            currentFolder.items.sort((a, b) => {
                if (a.type === 'folder' && b.type !== 'folder') return -1;
                if (a.type !== 'folder' && b.type === 'folder') return 1;
                const nameA = (a.name || "").toString();
                const nameB = (b.name || "").toString();
                return nameA.localeCompare(nameB);
            }).forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'dashboard-item';
                itemEl.dataset.id = item.id;
                itemEl.dataset.type = item.type;
                const displayName = item.name || "Untitled";

                if (item.type === 'quiz') {
                    const isLocal = !!item.data;
                    const canShare = isLocal || (item.backendSheetId); 
                    itemEl.classList.add('quiz-item');
                    itemEl.innerHTML = `
                        <div class="item-actions">
                            ${canShare ? '<button class="share-btn" title="Share Link">üîó</button>' : ''}
                            <button class="options-btn" title="Options">‚ãÆ</button>
                        </div>
                        <div class="card-content">
                            <div class="card-icon">${isLocal ? 'üìù' : '‚òÅÔ∏è'}</div>
                            <h3 class="item-name">${displayName}</h3>
                            <span class="item-type-label">${isLocal ? 'Local Quiz' : 'Backend Quiz'}</span>
                        </div>
                        <div class="dropdown-menu hidden">
                            <button data-action="re-edit">Re-edit</button>
                            <button data-action="rename">Rename</button>
                            <button data-action="move">Move to...</button>
                            <button data-action="copy">Copy</button>
                            ${clipboard ? `<button data-action="paste">Paste Quiz</button>`: ''}
                            <button data-action="delete" class="danger">Delete</button>
                        </div>
                    `;
                } else { // folder
                    itemEl.classList.add('folder-item');
                     itemEl.innerHTML = `
                        <div class="item-actions">
                            <button class="share-btn" title="Share Folder">üîó</button>
                            <button class="options-btn" title="Options">‚ãÆ</button>
                        </div>
                        <div class="card-content">
                            <div class="card-icon">üìÅ</div>
                            <h3 class="item-name">${displayName}</h3>
                            <span class="item-type-label">Folder</span>
                        </div>
                        <div class="dropdown-menu hidden">
                            <button data-action="rename">Rename</button>
                            ${clipboard ? `<button data-action="paste">Paste Quiz</button>`: ''}
                            <button data-action="delete" class="danger">Delete</button>
                        </div>
                    `;
                }
                dashboardContent.appendChild(itemEl);
            });
        }
        
        function generateShortShareLink(type, id, fullBackendUrl) {
            const match = fullBackendUrl.match(/\/s\/([^\/]+)\//);
            if(match && match[1]) {
                const deployId = match[1];
                return `#${type.charAt(0)}=${deployId}:${id}`;
            }
            return `#${type}=${id}&source=${encodeURIComponent(fullBackendUrl)}`;
        }

        dashboardContent.addEventListener('click', (e) => {
            const target = e.target;
            const itemEl = target.closest('.dashboard-item');
            if (!itemEl) return;
            const itemId = itemEl.dataset.id;
            const itemType = itemEl.dataset.type;

            if (target.classList.contains('options-btn')) {
                e.stopPropagation();
                const menu = itemEl.querySelector('.dropdown-menu');
                document.querySelectorAll('.dropdown-menu').forEach(m => { if (m !== menu) m.classList.add('hidden'); });
                menu.classList.toggle('hidden');
                return;
            }
            
            const action = target.dataset.action;
            if (action) {
                e.stopPropagation();
                handleItemAction(action, itemId, itemType);
                target.closest('.dropdown-menu').classList.add('hidden');
                return;
            }

            if (target.classList.contains('share-btn')) {
                e.stopPropagation();
                let shareHash = "";
                const baseUrl = window.location.href.split('#')[0];
                const backendUrl = localStorage.getItem('quiz_backend_url');
                
                if (itemType === 'folder') {
                    if(backendUrl) {
                        shareHash = generateShortShareLink('folder', itemId, backendUrl);
                    } else {
                        shareHash = `#folder=${itemId}`; 
                    }
                } else {
                    const quiz = findItem(itemId);
                    if(quiz.backendSheetId && backendUrl) {
                        shareHash = generateShortShareLink('quiz', quiz.backendSheetId, backendUrl);
                    } else {
                        shareHash = `#quiz=${itemId}`; 
                    }
                }
                const fullShareURL = baseUrl + shareHash;
                if(navigator.share) { navigator.share({ title: "Quiz Link", text: `Take this quiz!`, url: fullShareURL }).catch(console.error); } else { navigator.clipboard.writeText(fullShareURL).then(() => alert(`Link copied!\n\n${fullShareURL}`)); }
                return;
            }

            if (itemType === 'folder') { currentPath.push(itemId); renderDashboard(); } 
            else if (itemType === 'quiz') {
                const quiz = findItem(itemId);
                
                if (quiz && quiz.data) {
                    if(document.body.classList.contains('student-view')) {
                         initializePlayer(JSON.parse(JSON.stringify(quiz.data)));
                    } else {
                         initializePlayer(JSON.parse(JSON.stringify(quiz.data)));
                    }
                } else if (quiz && quiz.backendSheetId) {
                    const localBackend = localStorage.getItem('quiz_backend_url');
                    
                    if (!localBackend) {
                        alert('Cannot play quiz. Backend connection is lost. Please connect in the quiz builder.');
                        return;
                    }
                    const cardContent = itemEl.querySelector('.card-content');
                    cardContent.innerHTML += `<p class="status-processing" style="font-size:14px; margin-top:10px;">Loading quiz...</p>`;
                    
                    fetchBackendQuizData(quiz.backendSheetId, localBackend).then(data => {
                        if(data) {
                            data.backendSheetId = quiz.backendSheetId;
                            data.backendUrl = localBackend;
                            initializePlayer(data);
                        } else {
                            renderDashboard(); 
                        }
                    });
                } else {
                    alert('Could not load quiz data.');
                }
            }
        });
        
        document.addEventListener('click', (e) => { if (!e.target.closest('.dashboard-item')) { document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden')); } });

        breadcrumbTrail.addEventListener('click', (e) => {
            e.preventDefault();
            const folderId = e.target.dataset.folderId;
            if (folderId) {
                if (folderId === 'root') { currentPath = []; } else { const index = currentPath.indexOf(folderId); if (index > -1) { currentPath = currentPath.slice(0, index + 1); } }
                renderDashboard();
            }
        });

        function handleItemAction(action, itemId, itemType) {
            let db = getDb();
            let item = findItem(itemId, db);
            if (!item) return;

            switch (action) {
                case 'rename':
                    const newName = prompt(`Enter new name for "${item.name}":`, item.name);
                    if (newName && newName.trim() !== '') { 
                        item.name = newName.trim(); 
                        saveDb(db); 
                        syncToBackend(); 
                        renderDashboard(); 
                    }
                    break;
                case 'delete':
                    const confirmMsg = itemType === 'folder' ? `Are you sure you want to delete the folder "${item.name}"?` : `Are you sure you want to delete the quiz "${item.name}"?`;
                    if (confirm(confirmMsg)) {
                        const parent = findParent(itemId, db);
                        if(parent && parent.items){
                            const idx = parent.items.findIndex(i => i.id === itemId);
                            if (idx > -1) { 
                                parent.items.splice(idx, 1); 
                                saveDb(db); 
                                syncToBackend(); 
                                renderDashboard(); 
                            }
                        }
                    }
                    break;
                case 're-edit': showBuilder(itemId); break;
                case 'copy': clipboard = JSON.parse(JSON.stringify(item)); alert(`Copied "${item.name}" to clipboard.`); renderDashboard(); break;
                case 'paste':
                    if (clipboard) {
                        const newId = `q_${Date.now()}`;
                        const pastedItem = { ...clipboard, id: newId, name: `${clipboard.name} (Copy)` };
                        if(pastedItem.backendSheetId) {
                             pastedItem.id = `backend_${Date.now()}`;
                        }
                        let targetFolder = db; 
                        if(currentPath.length > 0) { targetFolder = findItem(currentPath[currentPath.length-1], db) || db; }
                        if (!targetFolder.items) targetFolder.items = [];
                        targetFolder.items.push(pastedItem);
                        saveDb(db);
                        syncToBackend();
                        renderDashboard();
                    }
                    break;
                case 'move': showMoveModal(itemId); break;
            }
        }
        
        const actionModal = document.getElementById('action-modal-overlay');
        document.getElementById('create-new-folder-btn').addEventListener('click', () => { actionModal.classList.remove('hidden'); actionModal.querySelector('#create-folder-modal').classList.remove('hidden'); document.getElementById('new-folder-name').focus(); });
        document.getElementById('create-folder-cancel').addEventListener('click', () => { actionModal.classList.add('hidden'); actionModal.querySelector('#create-folder-modal').classList.add('hidden'); });
        document.getElementById('create-folder-confirm').addEventListener('click', () => {
            const name = document.getElementById('new-folder-name').value.trim();
            if (name) {
                const db = getDb();
                let parent = db;
                if (currentPath.length > 0) {
                    const found = findItem(currentPath[currentPath.length-1], db);
                    if(found) parent = found;
                }
                const newFolder = { id: `f_${Date.now()}`, type: 'folder', name, items: [] };
                if (!parent.items) parent.items = [];
                parent.items.push(newFolder);
                saveDb(db); 
                syncToBackend(); 
                renderDashboard();
                actionModal.classList.add('hidden');
                actionModal.querySelector('#create-folder-modal').classList.add('hidden');
                document.getElementById('new-folder-name').value = '';
            } else { alert('Please enter a folder name.'); }
        });

        function showMoveModal(itemIdToMove) {
            const moveModal = document.getElementById('move-item-modal');
            const folderList = document.getElementById('move-folder-list');
            const confirmBtn = document.getElementById('move-item-confirm');
            const db = getDb();
            let listHTML = '<li data-folder-id="root">üè† Home (Root)</li>';
            function generateFolderList(items, depth = 0) {
                if (!items) return;
                items.forEach(item => {
                    if (item.type === 'folder' && item.id !== itemIdToMove) { 
                        listHTML += `<li data-folder-id="${item.id}">${'&nbsp;'.repeat(depth * 4)}üìÅ ${item.name}</li>`;
                        generateFolderList(item.items, depth + 1);
                    }
                });
            }
            generateFolderList(db.items); folderList.innerHTML = listHTML; confirmBtn.disabled = true;
            let selectedTargetId = null;
            folderList.onclick = (e) => { const li = e.target.closest('li'); if (li) { folderList.querySelectorAll('li').forEach(el => el.classList.remove('selected')); li.classList.add('selected'); selectedTargetId = li.dataset.folderId; confirmBtn.disabled = false; } };
            document.getElementById('move-item-confirm').onclick = () => {
                if (selectedTargetId !== null) {
                    const sourceParent = findParent(itemIdToMove, db);
                    if (sourceParent && sourceParent.items) {
                        const idx = sourceParent.items.findIndex(i => i.id === itemIdToMove);
                        if(idx > -1) {
                            const [itemToMove] = sourceParent.items.splice(idx, 1);
                            const destParent = selectedTargetId === 'root' ? db : findItem(selectedTargetId, db);
                            if (destParent) {
                                if (!destParent.items) destParent.items = [];
                                destParent.items.push(itemToMove);
                                saveDb(db); 
                                syncToBackend(); 
                                renderDashboard();
                                actionModal.classList.add('hidden'); moveModal.classList.add('hidden');
                            }
                        }
                    }
                }
            };
            document.getElementById('move-item-cancel').onclick = () => { actionModal.classList.add('hidden'); moveModal.classList.add('hidden'); };
            actionModal.classList.remove('hidden'); moveModal.classList.remove('hidden');
        }

        // --- BUILDER LOGIC ---
        let questionCount = 0, termsAndConditions = { content: null, type: null }, preQuizQuestions = [], isBackendConnected = false, logoSrc = null, quizAds = [];
        
        document.getElementById('back-to-dashboard-btn').addEventListener('click', showDashboard);
        document.getElementById('create-new-quiz-btn').addEventListener('click', () => showBuilder());

        // --- AD MANAGER LOGIC ---
        const adModalOverlay = document.getElementById('ad-management-modal-overlay');
        const adLinkInput = document.getElementById('ad-link-input');
        const adLinksContainer = document.getElementById('ad-links-container');

        document.getElementById('manage-ads-btn').addEventListener('click', () => {
            adModalOverlay.classList.remove('hidden');
            renderAdLinks();
        });

        document.getElementById('close-ad-modal-btn').addEventListener('click', () => {
            adModalOverlay.classList.add('hidden');
        });

        document.getElementById('add-ad-link-btn').addEventListener('click', () => {
            const link = adLinkInput.value.trim();
            if (link) {
                quizAds.push(link);
                adLinkInput.value = '';
                renderAdLinks();
            } else {
                alert("Please enter a valid link.");
            }
        });

        function renderAdLinks() {
            adLinksContainer.innerHTML = '';
            if (quizAds.length > 0) {
                adLinksContainer.style.display = 'block';
                quizAds.forEach((link, index) => {
                    const div = document.createElement('div');
                    div.className = 'ad-link-item';
                    div.innerHTML = `<span class="ad-link-text">${index+1}. ${link}</span> <button class="remove-ad-btn" data-index="${index}">Remove</button>`;
                    adLinksContainer.appendChild(div);
                });
            } else {
                adLinksContainer.style.display = 'none';
            }
        }
        
        adLinksContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-ad-btn')) {
                const idx = parseInt(e.target.dataset.index);
                quizAds.splice(idx, 1);
                renderAdLinks();
            }
        });

        function resetBuilder() {
            document.getElementById('quiz-builder-header').querySelector('h1').textContent = 'Create New Quiz';
            document.getElementById('editing-quiz-id').value = ''; document.getElementById('quiz-title').value = '';
            document.getElementById('quiz-org').value = '';
            document.getElementById('quiz-topic').value = ''; document.getElementById('quiz-time').value = '';
            logoSrc = null; document.getElementById('quiz-logo').value = '';
            document.getElementById('quiz-logo-preview').style.display = 'none'; document.getElementById('schedule-quiz-toggle').checked = false;
            document.getElementById('schedule-details-container').classList.add('hidden'); document.getElementById('quiz-terms').value = '';
            document.getElementById('terms-file-name').textContent = ''; termsAndConditions = { content: null, type: null };
            document.getElementById('questions-container').innerHTML = '<h2>Questions</h2>'; questionCount = 0;
            preQuizQuestions = []; document.getElementById('pre-quiz-questions-list').innerHTML = '';
            document.getElementById('collect-info-toggle').checked = false; document.getElementById('pre-quiz-questions-section').classList.add('hidden');
            quizAds = []; renderAdLinks();
        }

        function populateBuilder(quizData) {
            document.getElementById('quiz-title').value = quizData.quizTitle || '';
            document.getElementById('quiz-org').value = quizData.organization || '';
            document.getElementById('quiz-topic').value = quizData.quizTopic || '';
            document.getElementById('quiz-time').value = quizData.timeLimit || '';
            if (quizData.logoSrc) {
                logoSrc = quizData.logoSrc;
                const preview = document.getElementById('quiz-logo-preview');
                preview.src = logoSrc; preview.style.display = 'block';
            }
            if (quizData.advertisementLinks) {
                quizAds = quizData.advertisementLinks;
                renderAdLinks();
            }
            document.getElementById('questions-container').innerHTML = '<h2>Questions</h2>';
            questionCount = 0; const mainQuestions = {}; 
            quizData.questions.forEach(q => {
                if(q.isSubQuestion) {
                    const passageKey = JSON.stringify(q.passageData);
                    if (!mainQuestions[passageKey]) { mainQuestions[passageKey] = { isSubQuestionGroup: true, passageData: q.passageData, subQuestions: [] }; }
                    mainQuestions[passageKey].subQuestions.push(q);
                } else { mainQuestions[`q_${q.questionNumber}`] = q; }
            });
            Object.values(mainQuestions).forEach(qData => { if (!qData.isSubQuestionGroup) { createQuestionCard(qData); } });
        }
        
        document.getElementById('quiz-logo').addEventListener('change', (e) => {
            const file = e.target.files[0]; const preview = document.getElementById('quiz-logo-preview');
            if (file) { const reader = new FileReader(); reader.onload = (event) => { logoSrc = event.target.result; preview.src = logoSrc; preview.style.display = 'block'; }; reader.readAsDataURL(file); } else { logoSrc = null; preview.style.display = 'none'; }
        });
        
        const backendToggle = document.getElementById('backend-toggle'); const backendIndependentToggle = document.getElementById('backend-independent-toggle'); const backendDetailsContainer = document.getElementById('backend-details-container'); const testBackendBtn = document.getElementById('test-backend-btn'); const backendStatus = document.getElementById('backend-connection-status'); const backendUrlInput = document.getElementById('backend-url'); 
        const loadSavedBackendDetails = () => { const savedUrl = localStorage.getItem('quiz_backend_url'); if(savedUrl) { backendUrlInput.value = savedUrl; isBackendConnected = true; backendStatus.textContent = '‚úÖ Restored connection. Ready to save or fetch.'; backendStatus.className = 'status-success'; document.getElementById('get-my-quizzes-btn').classList.remove('hidden'); } }; 
        const updateBackendUI = () => { const showDetails = backendToggle.checked || backendIndependentToggle.checked; backendDetailsContainer.classList.toggle('hidden', !showDetails); }; 
        backendToggle.addEventListener('change', updateBackendUI); backendIndependentToggle.addEventListener('change', updateBackendUI);
        testBackendBtn.addEventListener('click', async () => { 
            const url = backendUrlInput.value.trim(); if (!url) { backendStatus.className = 'status-error'; backendStatus.textContent = '‚ùå Please enter URL.'; return; } 
            backendStatus.textContent = 'Testing...'; backendStatus.className = 'status-processing'; testBackendBtn.disabled = true; 
            try { 
                const response = await fetch(url, { method: 'POST', mode: 'cors', cache: 'no-cache', redirect: 'follow', body: JSON.stringify({ action: 'test' }), }); 
                const result = await response.json(); 
                if (result.status === 'success') { 
                    isBackendConnected = true; localStorage.setItem('quiz_backend_url', url); 
                    backendStatus.className = 'status-success'; backendStatus.textContent = `‚úÖ Connected! You can now use "Get My Quizzes" on the dashboard.`;
                    document.getElementById('get-my-quizzes-btn').classList.remove('hidden');
                } else { throw new Error(result.message || 'Error'); } 
            } catch (error) { 
                isBackendConnected = false; backendStatus.className = 'status-error'; backendStatus.textContent = `‚ùå Connection Failed. Check URL and "Anyone" permissions in Apps Script deployment.`; 
                document.getElementById('get-my-quizzes-btn').classList.add('hidden');
            } finally { testBackendBtn.disabled = false; } 
        });

        const addQuestionBtn=document.getElementById('add-question-btn'),questionsContainer=document.getElementById('questions-container'),previewQuizBtn=document.getElementById('preview-quiz-btn'),downloadQuizBtn=document.getElementById('download-quiz-btn'),collectInfoToggle=document.getElementById('collect-info-toggle'),preQuizSection=document.getElementById('pre-quiz-questions-section'),addPreQuestionBtn=document.getElementById('add-pre-question-btn'),preQuestionModal=document.getElementById('add-pre-question-modal-overlay'),preQuestionLabel=document.getElementById('pre-question-label'),preQuestionType=document.getElementById('pre-question-type'),preQuestionOptionsContainer=document.getElementById('pre-question-options-container'),preQuestionOptions=document.getElementById('pre-question-options'),addPreQuestionConfirm=document.getElementById('add-pre-question-confirm'),addPreQuestionCancel=document.getElementById('add-pre-question-cancel'),preQuizList=document.getElementById('pre-quiz-questions-list'),scheduleQuizToggle=document.getElementById('schedule-quiz-toggle'),scheduleDetailsContainer=document.getElementById('schedule-details-container'); scheduleQuizToggle.addEventListener('change',()=>{scheduleDetailsContainer.classList.toggle('hidden',!scheduleQuizToggle.checked)});collectInfoToggle.addEventListener('change',()=>{preQuizSection.classList.toggle('hidden',!collectInfoToggle.checked)});addPreQuestionBtn.addEventListener('click',()=>{preQuestionModal.classList.remove('hidden')});addPreQuestionCancel.addEventListener('click',()=>{preQuestionModal.classList.add('hidden')});preQuestionType.addEventListener('change',()=>{preQuestionOptionsContainer.classList.toggle('hidden',preQuestionType.value!=='predefined-options')});document.getElementById('quiz-terms').addEventListener('change',(e)=>{const file=e.target.files[0];const fileNameSpan=document.getElementById('terms-file-name');if(file){const reader=new FileReader();reader.onload=(event)=>{termsAndConditions.content=event.target.result;termsAndConditions.type=file.type;};reader.readAsDataURL(file);fileNameSpan.textContent=`File selected: ${file.name}`;}else{termsAndConditions={content:null,type:null};fileNameSpan.textContent='';}});
        function renderPreQuizQuestionList(){preQuizList.innerHTML='';preQuizQuestions.forEach((q,index)=>{const li=document.createElement('li');li.className='pre-quiz-list-item';const typeText=q.type==='predefined-options'?`predefined options ${q.useSearch?'(Search)':'(Dropdown)'}`:q.type.replace('-',' ');li.innerHTML=`<span class="pre-quiz-list-item-text"><strong>${q.label}</strong> ‚Äì ${typeText}</span><div class="pre-quiz-list-item-actions"><button data-index="${index}" class="delete-pre-quiz-btn">üóëÔ∏è</button></div>`;preQuizList.appendChild(li)})}preQuizList.addEventListener('click',(e)=>{if(e.target.classList.contains('delete-pre-quiz-btn')){const index=parseInt(e.target.dataset.index,10);preQuizQuestions.splice(index,1);renderPreQuizQuestionList()}});addPreQuestionConfirm.addEventListener('click',()=>{const label=preQuestionLabel.value.trim();const type=preQuestionType.value;if(!label){alert('Please enter a question label.');return}const newQuestion={label,type,options:[],useSearch:false};if(type==='predefined-options'){newQuestion.options=preQuestionOptions.value.split('\n').map(o=>o.trim()).filter(o=>o);newQuestion.useSearch=document.getElementById('pre-question-search-toggle').checked;if(newQuestion.options.length===0){alert('Please provide at least one option.');return}}preQuizQuestions.push(newQuestion);renderPreQuizQuestionList();preQuestionLabel.value='';preQuestionOptions.value='';preQuestionType.value='short-text';preQuestionOptionsContainer.classList.add('hidden');document.getElementById('pre-question-search-toggle').checked=false;preQuestionModal.classList.add('hidden')});
        function addSubQuestion(mainQuestionCard){const container=mainQuestionCard.querySelector('.sub-questions-container');const isShortAnswer=mainQuestionCard.querySelector('.sub-question-type-toggle').checked;const subQuestionCount=container.children.length+1;const subQuestionCard=document.createElement('div');subQuestionCard.className='card sub-question-card';if(isShortAnswer){subQuestionCard.dataset.type='short-answer';subQuestionCard.innerHTML=`<button class="delete-sub-question-btn">&times;</button><div class="form-group"><label>Sub Q ${subQuestionCount} (Short Answer)</label><div class="sub-question-text-rte"></div></div><div class="form-group"><label>Correct Answer</label><input type="text" class="sub-question-answer" placeholder="Enter the exact correct answer"></div>`;createRichTextEditor(subQuestionCard.querySelector('.sub-question-text-rte'),'Enter sub-question text')}else{subQuestionCard.dataset.type='mcq';const uniqueId=`sq-${Date.now()}-${Math.floor(Math.random()*1000)}`;subQuestionCard.innerHTML=`<button class="delete-sub-question-btn">&times;</button><div class="form-group"><label>Sub Q ${subQuestionCount} (MCQ)</label><div class="sub-question-text-rte"></div></div><div class="form-group"><label>Options</label><div class="options-container"></div><button class="btn btn-primary add-option-btn" style="font-size: 12px; padding: 5px 10px; background-color: #6c757d;">Add Option</button></div>`;createRichTextEditor(subQuestionCard.querySelector('.sub-question-text-rte'),'Enter sub-question text');const optionsContainer=subQuestionCard.querySelector('.options-container');addOptionToContainer(optionsContainer,uniqueId);addOptionToContainer(optionsContainer,uniqueId)}container.appendChild(subQuestionCard)}
        const autoArrangeBtn=document.getElementById('auto-arrange-btn'),excelImportOverlay=document.getElementById('excel-import-overlay'),processImportBtn=document.getElementById('process-import-btn'),cancelImportBtn=document.getElementById('cancel-import-btn'),spreadsheetBody=document.getElementById('spreadsheet-body'),ssAddRowBtn=document.getElementById('ss-add-row-btn'),ssDelRowBtn=document.getElementById('ss-del-row-btn');let selectedRowElement=null; function initSpreadsheet(){spreadsheetBody.innerHTML='';for(let i=0;i<5;i++)addSpreadsheetRow()} function addSpreadsheetRow(){const tr=document.createElement('tr');for(let i=0;i<7;i++){const td=document.createElement('td');const div=document.createElement('div');div.contentEditable=true;div.className='spreadsheet-cell';div.addEventListener('paste',handlePaste);div.addEventListener('focus',(e)=>{if(selectedRowElement)selectedRowElement.classList.remove('spreadsheet-row-selected');selectedRowElement=tr;selectedRowElement.classList.add('spreadsheet-row-selected')});td.appendChild(div);tr.appendChild(td)}spreadsheetBody.appendChild(tr)} function handlePaste(e){e.preventDefault();const text=(e.clipboardData||window.clipboardData).getData('text');const rows=text.split(/\r\n|\n|\r/);const currentRow=e.target.closest('tr');const currentCell=e.target.closest('td');const startRowIndex=Array.from(spreadsheetBody.children).indexOf(currentRow);const startColIndex=Array.from(currentRow.children).indexOf(currentCell);rows.forEach((rowText,rIdx)=>{if(!rowText.trim()&&rIdx===rows.length-1)return;if(startRowIndex+rIdx>=spreadsheetBody.children.length){addSpreadsheetRow()}const targetRow=spreadsheetBody.children[startRowIndex+rIdx];const cols=rowText.split('\t');cols.forEach((colText,cIdx)=>{if(startColIndex+cIdx<targetRow.children.length){const cellDiv=targetRow.children[startColIndex+cIdx].querySelector('.spreadsheet-cell');cellDiv.innerText=colText}})})};autoArrangeBtn.addEventListener('click',()=>{excelImportOverlay.classList.remove('hidden');initSpreadsheet()});cancelImportBtn.addEventListener('click',()=>{excelImportOverlay.classList.add('hidden')});ssAddRowBtn.addEventListener('click',addSpreadsheetRow);ssDelRowBtn.addEventListener('click',()=>{if(selectedRowElement){selectedRowElement.remove();selectedRowElement=null}else{if(spreadsheetBody.lastElementChild)spreadsheetBody.lastElementChild.remove()}});processImportBtn.addEventListener('click',()=>{let importCount=0;const rows=Array.from(spreadsheetBody.children);rows.forEach((tr)=>{const cells=tr.querySelectorAll('.spreadsheet-cell');const qText=cells[0].innerText.trim();if(!qText)return;const options=[cells[1].innerText.trim(),cells[2].innerText.trim(),cells[3].innerText.trim(),cells[4].innerText.trim()].filter(o=>o!=="");const correctStr=cells[5].innerText.trim().toLowerCase();const explanation=cells[6].innerText.trim();let correctIndex=-1;if(correctStr==='a'||correctStr==='option a')correctIndex=0;else if(correctStr==='b'||correctStr==='option b')correctIndex=1;else if(correctStr==='c'||correctStr==='option c')correctIndex=2;else if(correctStr==='d'||correctStr==='option d')correctIndex=3;else{options.forEach((opt,i)=>{if(opt.toLowerCase()===correctStr)correctIndex=i})};createQuestionCard({text:qText,options:options,correctIndex:correctIndex,explanation:explanation});importCount++});excelImportOverlay.classList.add('hidden');if(importCount===0)alert("No valid data found in grid.")});
        function createQuestionCard(importData=null){questionCount++;const questionId=`q${questionCount}`;const questionCard=document.createElement('div');questionCard.className='card question-card';questionCard.id=`question-card-${questionId}`;questionCard.innerHTML=`<button class="delete-question-btn">&times;</button><div class="question-header"><label>Main Q ${questionCount}</label><div class="toggle-switch-container"><div class="toggle-switch"><span>Text</span><label class="switch"><input type="checkbox" class="question-type-toggle"><span class="slider"></span></label><span>Image</span></div><div class="toggle-switch"><span>Single Q</span><label class="switch"><input type="checkbox" class="sub-question-toggle"><span class="slider"></span></label><span>Sub-Qs</span></div><div class="toggle-switch"><span>Explanation</span><label class="switch"><input type="checkbox" class="explanation-toggle"><span class="slider"></span></label><span>On</span></div></div></div><div class="form-group"><div class="text-input-container"><div class="question-text-rte"></div></div><div class="image-uploader"><input type="file" class="image-input" accept="image/*"><img class="question-image-preview" src="#" alt="Image Preview"/></div></div><div class="explanation-section hidden"><label>Explanation (Hidden during quiz, shown in results)</label><div class="explanation-rte"></div></div><div class="main-question-options"><div class="form-group"><label>Options (select the correct answer)</label><div class="options-container"></div><button class="btn btn-primary add-option-btn" style="margin-top: 10px; background-color: #6c757d;">Add Option</button></div></div><div class="sub-questions-section" style="display:none;"><hr style="margin: 20px 0;"><div class="question-header" style="justify-content: flex-start; gap: 20px;"><h4>Sub-Questions</h4><div class="toggle-switch"><span>MCQ</span><label class="switch"><input type="checkbox" class="sub-question-type-toggle"><span class="slider"></span></label><span>Short Answer</span></div></div><div class="sub-questions-container"></div><button class="btn btn-primary add-sub-question-btn" style="margin-top: 10px;">Add Sub Q</button></div>`;questionsContainer.appendChild(questionCard);const qRte=questionCard.querySelector('.question-text-rte');const expRte=questionCard.querySelector('.explanation-rte');createRichTextEditor(qRte,'Enter question or passage text');createRichTextEditor(expRte,'Enter explanation here...');const optionsContainer=questionCard.querySelector('.options-container');if(importData){qRte.querySelector('.rte-content').innerHTML=importData.text||importData.passageData?.content; if(importData.explanation&&importData.explanation.trim()!==""){questionCard.querySelector('.explanation-toggle').checked=true;questionCard.querySelector('.explanation-section').classList.remove('hidden');expRte.querySelector('.rte-content').innerHTML=importData.explanation}importData.options.forEach((optText,idx)=>{addOptionToContainer(optionsContainer,questionId,optText,idx===importData.correctIndex)})}else{addOptionToContainer(optionsContainer,questionId);addOptionToContainer(optionsContainer,questionId)}}
        addQuestionBtn.addEventListener('click',()=>createQuestionCard());
        function addOptionToContainer(container,radioGroupName,text=null,isCorrect=false){if(!container)return;const optionItem=document.createElement('div');optionItem.className='option-item';optionItem.innerHTML=`<input type="radio" name="correct-answer-${radioGroupName}"><div class="option-rte-container"></div><button class="delete-option-btn">&times;</button>`;container.appendChild(optionItem);createRichTextEditor(optionItem.querySelector('.option-rte-container'),`Option ${container.children.length}`);if(text){optionItem.querySelector('.rte-content').innerHTML=text}if(isCorrect){optionItem.querySelector('input[type="radio"]').checked=true}}
        document.addEventListener('change',(e)=>{if(e.target.classList.contains('question-type-toggle')){const card=e.target.closest('.question-card');card.querySelector('.text-input-container').style.display=e.target.checked?'none':'block';card.querySelector('.image-uploader').style.display=e.target.checked?'block':'none'}if(e.target.classList.contains('sub-question-toggle')){const card=e.target.closest('.question-card');card.querySelector('.main-question-options').style.display=e.target.checked?'none':'block';card.querySelector('.sub-questions-section').style.display=e.target.checked?'block':'none'}if(e.target.classList.contains('explanation-toggle')){const card=e.target.closest('.question-card');card.querySelector('.explanation-section').classList.toggle('hidden',!e.target.checked)}if(e.target.classList.contains('image-input')){const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=(event)=>{const img=e.target.nextElementSibling;img.src=event.target.result;img.style.display='block';img.dataset.base64=event.target.result};reader.readAsDataURL(file)}}});document.addEventListener('click',(e)=>{if(e.target.classList.contains('delete-question-btn'))e.target.closest('.question-card').remove();if(e.target.classList.contains('add-option-btn'))addOptionToContainer(e.target.previousElementSibling,e.target.closest('.question-card')?e.target.closest('.question-card').id.replace('question-card-',''):`sq-${Date.now()}`);if(e.target.classList.contains('delete-option-btn'))e.target.closest('.option-item').remove();if(e.target.classList.contains('add-sub-question-btn'))addSubQuestion(e.target.closest('.question-card'));if(e.target.classList.contains('delete-sub-question-btn'))e.target.closest('.sub-question-card').remove()});
        
        function collectQuizData() {
            const title = document.getElementById('quiz-title').value || 'Untitled Quiz'; const topic = document.getElementById('quiz-topic').value || 'General'; const timeLimit = parseInt(document.getElementById('quiz-time').value) || 0;
            const org = document.getElementById('quiz-org').value || '';
            const folderStructure = currentPath.map(folderId => { const folder = findItem(folderId); return folder ? { id: folder.id, name: folder.name } : null; }).filter(f => f);
            const shouldSchedule = document.getElementById('schedule-quiz-toggle').checked; let scheduledDateTime = null; if (shouldSchedule) { const date = document.getElementById('quiz-schedule-date').value; const time = document.getElementById('quiz-schedule-time').value; if (date && time) scheduledDateTime = `${date}T${time}`; }
            const allQuestions = []; let mainQNum = 0; document.querySelectorAll('.question-card').forEach((card) => { const isImage = card.querySelector('.question-type-toggle').checked; const hasSubQuestions = card.querySelector('.sub-question-toggle').checked; const hasExplanation = card.querySelector('.explanation-toggle').checked; const explanationText = hasExplanation ? card.querySelector('.explanation-rte .rte-content').innerHTML : ""; if (hasSubQuestions) { const passageData = { type: isImage ? 'image' : 'text', content: isImage ? (card.querySelector('.question-image-preview')?.dataset.base64 || '') : (card.querySelector('.question-text-rte .rte-content').innerHTML || '') }; let subQNum = 0; card.querySelectorAll('.sub-question-card').forEach((subCard) => { subQNum++; const subQuestionData = { type: subCard.dataset.type, text: subCard.querySelector('.sub-question-text-rte .rte-content').innerHTML, selectedOption: null, fixed: false, marked: false, passageData: passageData, isSubQuestion: true, questionNumber: subQNum.toString() }; if (subCard.dataset.type === 'short-answer') { subQuestionData.answer = subCard.querySelector('.sub-question-answer').value; } else { subQuestionData.options = []; subCard.querySelectorAll('.option-item').forEach((item) => { const text = item.querySelector('.rte-content').innerHTML; if (text && text.trim() !== '<p><br></p>') { subQuestionData.options.push(text); if (item.querySelector('input[type="radio"]').checked) subQuestionData.correctIndex = subQuestionData.options.length - 1; } }); } allQuestions.push(subQuestionData); }); } else { mainQNum++; const questionData = { type: isImage ? 'image-mcq' : 'text-mcq', selectedOption: null, fixed: false, marked: false, passageData: null, isSubQuestion: false, questionNumber: mainQNum.toString(), explanation: explanationText }; if (isImage) { questionData.imageSrc = card.querySelector('.question-image-preview')?.dataset.base64 || ''; } else { questionData.text = card.querySelector('.question-text-rte .rte-content').innerHTML; } questionData.options = []; card.querySelectorAll('.main-question-options .option-item').forEach((item) => { const text = item.querySelector('.rte-content').innerHTML; if (text && text.trim() !== '<p><br></p>') { questionData.options.push(text); if (item.querySelector('input[type="radio"]').checked) questionData.correctIndex = questionData.options.length - 1; } }); allQuestions.push(questionData); } });
            const shouldCollectInfo = document.getElementById('collect-info-toggle').checked;
            const data = { quizTitle: title, organization: org, quizTopic: topic, timeLimit, questions: allQuestions, terms: termsAndConditions, preQuizQuestions: shouldCollectInfo ? preQuizQuestions : [], scheduledDateTime: scheduledDateTime, isIndependentBackend: document.getElementById('backend-independent-toggle').checked, logoSrc: logoSrc, folderStructure: folderStructure, advertisementLinks: quizAds };
            data.quizId = `id_${Date.now()}`;
            if (currentPath.length > 0) { data.parentFolderId = currentPath[currentPath.length - 1]; } else { data.parentFolderId = 'root'; }
            if (backendToggle.checked || backendIndependentToggle.checked && isBackendConnected) { data.backendUrl = backendUrlInput.value.trim(); }
            return data;
        }
        
        previewQuizBtn.addEventListener('click', () => { const quizData = collectQuizData(); if (quizData.questions.length === 0) { alert('Please add at least one question!'); return; } initializePlayer(JSON.parse(JSON.stringify(quizData))); });
        
        downloadQuizBtn.addEventListener('click', async () => {
            if ((backendToggle.checked || backendIndependentToggle.checked) && !isBackendConnected) { alert('Backend mode enabled but not connected. Please enter URL and click "Test Connection".'); return; }
            const quizData = collectQuizData(); 
            if (quizData.questions.length === 0) { alert('Please add at least one question.'); return; }
            downloadQuizBtn.disabled = true; downloadQuizBtn.textContent = "Saving...";
            
            const db = getDb();
            const editingId = document.getElementById('editing-quiz-id').value;
            let quizEntry;
            if (editingId) {
                quizEntry = findItem(editingId, db);
                if(quizEntry) { quizEntry.name = quizData.quizTitle; quizEntry.data = quizData; }
            } else {
                let parent = db; if (currentPath.length > 0) { parent = findItem(currentPath[currentPath.length-1], db) || db; }
                quizEntry = { id: `q_${Date.now()}`, type: 'quiz', name: quizData.quizTitle, data: quizData };
                if (!parent.items) parent.items = []; parent.items.push(quizEntry);
            }
            saveDb(db);
            alert(`Quiz "${quizData.quizTitle}" saved to your local dashboard!`);
            
            if (isBackendConnected && (backendToggle.checked || backendIndependentToggle.checked)) {
                downloadQuizBtn.textContent = "Saving to Backend...";
                try {
                    const response = await fetch(quizData.backendUrl, { method: 'POST', mode: 'cors', cache: 'no-cache', body: JSON.stringify({ action: 'create_quiz_sheet', quizData: quizData }) });
                    const result = await response.json();
                    if(result.status === 'success' && result.sheetId) { 
                        quizData.backendSheetId = result.sheetId; 
                        if(quizEntry) { quizEntry.backendSheetId = result.sheetId; saveDb(db); renderDashboard(); }
                        console.log("Backend sheet created/updated:", result.sheetId); 
                    } else { throw new Error(result.message || "Backend failed to create sheet."); }
                } catch(e) { 
                    alert("Error saving to Backend: " + e.message + "\nThe quiz will be downloaded locally without a backend link."); 
                    delete quizData.backendUrl; 
                }
            }

            downloadQuizBtn.textContent = "Generating File...";
            let suggestedName = quizData.quizTitle.trim().replace(/\s+/g, '_') || "quiz_download"; 
            let fileName = prompt("Enter filename for local HTML download:", suggestedName); 
            if(fileName === null) { downloadQuizBtn.disabled = false; downloadQuizBtn.textContent = "Download Quiz & Save"; return; } 
            
            const cssStyles = [...document.querySelectorAll('style')].map(s => s.innerHTML).join('\n');
            let playerHTML = document.getElementById('quiz-play-fullscreen').outerHTML + 
                             document.getElementById('popup-overlay').outerHTML + 
                             document.getElementById('ad-start-overlay').outerHTML + 
                             document.getElementById('student-loading').outerHTML +
                             document.getElementById('ad-toast').outerHTML +
                             document.getElementById('special-char-popup').outerHTML;
            playerHTML = playerHTML.replace(/<button class="exit-quiz-btn".*?<\/button>/, '<!-- Exit button removed for candidates -->');
            const playerScript = `const QUIZ_DATA = ${JSON.stringify(quizData)};\nconst initializePlayer = ${initializePlayer.toString()};\ndocument.addEventListener('DOMContentLoaded', () => initializePlayer(QUIZ_DATA));`;
            const quizFileContent = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${quizData.quizTitle}</title><style>${cssStyles}</style></head><body>${playerHTML}<script>${playerScript}<\/script></body></html>`;
            const blob = new Blob([quizFileContent], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (fileName.trim() || suggestedName) + '.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            
            downloadQuizBtn.disabled = false; downloadQuizBtn.textContent = "Download Quiz & Save";
            showDashboard();
        });
        
        document.getElementById('get-my-quizzes-btn').addEventListener('click', async () => {
            const backendUrl = localStorage.getItem('quiz_backend_url');
            if (!backendUrl) { alert('No backend URL configured. Please connect in the quiz builder first.'); return; }
            
            const btn = document.getElementById('get-my-quizzes-btn');
            btn.textContent = 'Fetching...'; btn.disabled = true;
            
            const result = await fetchAllBackendData(backendUrl);
            
            if (result) {
                renderDashboard();
                let qCount = result.quizzes ? result.quizzes.length : 0;
                let fCount = result.folders ? result.folders.length : 0;
                alert(`‚úÖ Sync Successful!\n\nüìÇ Folders: ${fCount}\nüìù Quizzes: ${qCount}`);
            } else {
                alert("Failed to fetch quizzes.");
            }
            btn.textContent = 'üîÑ Get My Quizzes'; btn.disabled = false;
        });

        // --- HELPER TO EXTRACT GOOGLE DEPLOYMENT ID & PARSE LINKS ---
        function parseHashParams() {
            const hash = window.location.hash.substring(1);
            if(hash.startsWith('q=') || hash.startsWith('f=')) {
                // Short link format: #q=DEPLOY_ID:QUIZ_ID
                const typeChar = hash.charAt(0);
                const rawVal = decodeURIComponent(hash.substring(2));
                const [deployId, resourceId] = rawVal.split(':');
                const backendUrl = `https://script.google.com/macros/s/${deployId}/exec`;
                
                return {
                    [typeChar === 'q' ? 'quiz' : 'folder']: resourceId,
                    source: backendUrl
                };
            }
            
            // Legacy/Long format
            const params = {};
            hash.split('&').forEach(part => {
                const [key, value] = part.split('=');
                if (key) params[key] = decodeURIComponent(value || '');
            });
            return params;
        }

        function initialize_app() {
            loadSavedBackendDetails();
            const params = parseHashParams();
            const hash = window.location.hash;
            
            // Check for both long format (#quiz=...) and short format (#q=...)
            if (params.quiz) {
                // STUDENT VIEW: QUIZ
                document.body.classList.add('student-view'); // Hide Editor UI
                document.getElementById('quiz-dashboard').classList.add('hidden'); // Ensure Dashboard hidden
                
                const quizId = params.quiz;
                const sourceUrl = params.source; // Backend URL if shared

                if (sourceUrl && quizId) {
                    loadingScreen.classList.remove('hidden');
                    fetchBackendQuizData(quizId, sourceUrl).then(data => {
                        loadingScreen.classList.add('hidden');
                        if(data) {
                            data.backendSheetId = quizId;
                            data.backendUrl = sourceUrl;
                            initializePlayer(data);
                        } else {
                            alert("Failed to load quiz from link.");
                        }
                    });
                    return;
                }

                // Fallback to Local Data
                const quiz = findItem(quizId);
                if (quiz) {
                    if(quiz.data) initializePlayer(JSON.parse(JSON.stringify(quiz.data)));
                    else if(quiz.backendSheetId) {
                        const localBackend = localStorage.getItem('quiz_backend_url');
                        if(localBackend) {
                            fetchBackendQuizData(quiz.backendSheetId, localBackend).then(data => {
                                if(data) {
                                    data.backendSheetId = quiz.backendSheetId;
                                    data.backendUrl = localBackend;
                                    initializePlayer(data);
                                }
                            });
                        } else {
                            alert("Backend connection missing locally.");
                        }
                    }
                } else {
                    alert('Quiz not found locally.');
                }
            } else if (params.folder) {
                // STUDENT VIEW: FOLDER
                document.body.classList.add('student-view'); 
                
                const folderId = params.folder;
                const sourceUrl = params.source;

                if (sourceUrl && folderId) {
                    loadingScreen.classList.remove('hidden');
                    document.getElementById('loading-text').textContent = "Loading Folder...";
                    
                    fetchAllBackendData(sourceUrl).then(result => {
                        loadingScreen.classList.add('hidden');
                        if(result) {
                            const folder = findItem(folderId);
                            if(folder) {
                                currentPath = [folderId];
                                renderDashboard();
                            } else {
                                alert("Folder not found in fetched data.");
                            }
                        } else {
                            alert("Failed to fetch folder data.");
                        }
                    });
                } else {
                    const folder = findItem(folderId);
                    if(folder) {
                        currentPath = [folderId]; 
                        renderDashboard();
                    } else {
                        alert('Folder not found locally.');
                    }
                }
            } else {
                // NORMAL EDITOR VIEW
                showDashboard();
            }
        }

        initialize_app();
    });
    </script>
</body>
</html>
